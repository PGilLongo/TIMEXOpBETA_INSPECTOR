<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Base de datos</title>
<style>
  :root{
    --w95-bg:#c0c0c0;
    --w95-light:#ffffff;
    --w95-shadow:#404040;
    --w95-blue:#000080;
    --w95-hilite:#dfdfdf;
    --text:#000000;
    --surface:#ffffff;
  }

  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background: var(--w95-bg);
    color: var(--text);
  }

  button, input, select{ font-family: inherit; }

  .window{
    border-top:2px solid var(--w95-light);
    border-left:2px solid var(--w95-light);
    border-right:2px solid var(--w95-shadow);
    border-bottom:2px solid var(--w95-shadow);
    background: var(--w95-bg);
  }

  .panel.window{
    width:100%;
    min-height:100vh;
    display:flex;
    flex-direction:column;
  }

  .titlebar{
    background: var(--w95-blue);
    color:#fff;
    padding:6px 10px;
    font-weight:800;
    font-size:13px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    position:sticky;
    top:0;
    z-index:50;
    border-bottom:2px solid var(--w95-shadow);
    user-select:none;
  }

  .content{
    padding:12px;
    flex:1;
    max-width:1200px;
    width:100%;
    margin:0 auto;
  }

  .box{
    padding:10px;
    background: var(--w95-hilite);
    border-top:2px solid var(--w95-shadow);
    border-left:2px solid var(--w95-shadow);
    border-right:2px solid var(--w95-light);
    border-bottom:2px solid var(--w95-light);
    margin:10px 0 12px;
  }

  label{
    display:block;
    font-size:12px;
    margin-bottom:4px;
    font-weight:800;
  }

  input[type="text"],
  input[type="datetime-local"],
  select{
    width:100%;
    max-width:100%;
    min-width:0;
    padding:8px 10px;
    border-top:2px solid var(--w95-shadow);
    border-left:2px solid var(--w95-shadow);
    border-right:2px solid var(--w95-light);
    border-bottom:2px solid var(--w95-light);
    background: var(--surface);
    font-size:13px;
  }

  button{
    border-top:2px solid var(--w95-light);
    border-left:2px solid var(--w95-light);
    border-right:2px solid var(--w95-shadow);
    border-bottom:2px solid var(--w95-shadow);
    background: var(--w95-bg);
    padding:8px 12px;
    font-weight:800;
    font-size:12px;
    cursor:pointer;
    white-space:nowrap;
  }
  button:active{
    border-top:2px solid var(--w95-shadow);
    border-left:2px solid var(--w95-shadow);
    border-right:2px solid var(--w95-light);
    border-bottom:2px solid var(--w95-light);
  }
  button.primary{ background: var(--w95-hilite); }
  button.danger{ background:#ffd6d6; }
  button:disabled{
    opacity:.6;
    cursor:not-allowed;
  }

  .gridFilters{
    display:grid;
    grid-template-columns: repeat(12, minmax(0, 1fr));
    gap:10px;
    align-items:end;
  }
  .gridFilters > div{ min-width:0; }

  .col-12{ grid-column: span 12; }
  .col-6{ grid-column: span 6; }
  .col-4{ grid-column: span 4; }
  .col-3{ grid-column: span 3; }

  .rowActions{
    display:flex;
    gap:10px;
    margin-top:10px;
    align-items:center;
    flex-wrap:wrap;
  }

  .muted{ opacity:.75; font-size:12px; }

  .histEmpty{
    padding:14px;
    background: var(--surface);
    border-top:2px solid var(--w95-shadow);
    border-left:2px solid var(--w95-shadow);
    border-right:2px solid var(--w95-light);
    border-bottom:2px solid var(--w95-light);
    font-size:13px;
  }

  .tableWrap{
    width:100%;
    overflow:auto;
    border-top:2px solid var(--w95-shadow);
    border-left:2px solid var(--w95-shadow);
    border-right:2px solid var(--w95-light);
    border-bottom:2px solid var(--w95-light);
    background: var(--surface);
  }

  table.histTable{
    width:100%;
    border-collapse:collapse;
    background: var(--surface);
    font-size:13px;
    min-width:620px;
  }
  table.histTable th, table.histTable td{
    padding:10px 10px;
    border-bottom:1px solid #d0d0d0;
    text-align:left;
    vertical-align:middle;
  }
  table.histTable th{
    background: var(--w95-hilite);
    font-size:12px;
    user-select:none;
    position:sticky;
    top:0;
    z-index:1;
  }
  table.histTable tr:hover td{ background:#f6f6ff; }

  .pager{
    margin-top:10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .pager .meta{
    font-size:12px;
    opacity:.9;
  }
  .pager .controls{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }
  .pill{
    display:inline-block;
    padding:4px 8px;
    background: var(--surface);
    border-top:2px solid var(--w95-shadow);
    border-left:2px solid var(--w95-shadow);
    border-right:2px solid var(--w95-light);
    border-bottom:2px solid var(--w95-light);
    font-size:12px;
    font-weight:800;
  }

  @media (max-width: 900px){
    .col-6, .col-4, .col-3{ grid-column: span 12; }
  }

  @media (max-width: 420px){
    .content{ padding:10px; }
    button{ width:100%; }
    .pager .controls button{ width:auto; }
  }
</style>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
</head>

<body>
<div class="panel window">
  <div class="titlebar">
    <div>Base de datos</div>
  </div>

  <div class="content">
    <div class="box">
      <div class="gridFilters">
        <div class="col-12">
          <label for="histSearch">Búsqueda rápida</label>
          <input id="histSearch" type="text" placeholder="Filtra por texto…" autocomplete="off" inputmode="search" />
          <div class="rowActions">
            <button id="btnBuscar" type="button">Buscar</button>
            <button id="btnCargarTodas" type="button">Cargar todas</button>
          </div>
        </div>

        <div class="col-3">
          <label for="advCategory">Filtro: categoría</label>
          <select id="advCategory">
            <option value="">(Todas)</option>
          </select>
        </div>

        <div class="col-3">
          <label for="advForm">Filtro: formulario contiene</label>
          <input id="advForm" type="text" placeholder="Ej: Checklist…" autocomplete="off" />
        </div>

        <div class="col-3">
          <label for="advFrom">Fecha desde</label>
          <input id="advFrom" type="datetime-local" />
        </div>

        <div class="col-3">
          <label for="advTo">Fecha hasta</label>
          <input id="advTo" type="datetime-local" />
        </div>

        <div class="col-12" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <button id="btnLimpiar" type="button">Limpiar filtros</button>
          <span class="muted">Mostrando <b>50</b> registros por página.</span>
        </div>
      </div>
    </div>

    <div id="histList" aria-live="polite"></div>
  </div>
</div>

<script>
window.addEventListener('error', (e)=>{ try{ console.error('JS error:', e.error || e.message, e); }catch(_){} });
window.addEventListener('unhandledrejection', (e)=>{ try{ console.error('Unhandled promise rejection:', e.reason); }catch(_){} });

const firebaseConfig = {
  apiKey: "AIzaSyBLP0yGc_Yh0nKGNYbPcYabTg25LDw2wco",
  authDomain: "inspector-b4f41.firebaseapp.com",
  projectId: "inspector-b4f41",
  storageBucket: "inspector-b4f41.firebasestorage.app",
  messagingSenderId: "333394046622",
  appId: "1:333394046622:web:caa18c6f1d341b0a97158f"
};

const COLLECTION_NAME = 'inspections_v1';
const INS_COLLECTION = COLLECTION_NAME;
const PAGE_SIZE = 50;

let __page = 1;
let __dbCache = [];
let __cacheLoaded = false;
let __loadedAll = false;

let __fire = { app: null, db: null, col: null };

function nowISO(){ try{ return new Date().toISOString(); }catch(e){ return ''+Date.now(); } }
function makeId(){ return 'id_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 10); }
function normalizeStr(s){ return String(s ?? '').trim(); }
function normalizeLower(s){ return normalizeStr(s).toLowerCase(); }

function stableSerialize(val){
  const t = typeof val;
  if(val === null) return 'null';
  if(t === 'string') return JSON.stringify(val);
  if(t === 'number' || t === 'boolean') return String(val);
  if(t !== 'object') return JSON.stringify(String(val));
  if(Array.isArray(val)) return '[' + val.map(stableSerialize).join(',') + ']';
  const keys = Object.keys(val).sort((a,b)=> a.localeCompare(b, 'en', { sensitivity:'base' }));
  return '{' + keys.map(k => JSON.stringify(k)+':'+stableSerialize(val[k])).join(',') + '}';
}

function hashString(str){
  let h = 5381;
  for(let i=0;i<str.length;i++) h = ((h << 5) + h) ^ str.charCodeAt(i);
  return (h >>> 0).toString(16).padStart(8,'0');
}

function hasLayoutShape(obj){
  return !!(obj && typeof obj === 'object' && obj.header && typeof obj.header === 'object' && Array.isArray(obj.fields));
}

function extractLayout(raw){
  if(!raw || typeof raw !== 'object') return null;
  if(hasLayoutShape(raw)) return raw;
  if(raw.data && typeof raw.data === 'object' && hasLayoutShape(raw.data)) return raw.data;
  if(raw.layout && typeof raw.layout === 'object' && hasLayoutShape(raw.layout)) return raw.layout;
  return null;
}

function computeFingerprint(category, form, lastEditedISO, raw){
  try{
    const layout = extractLayout(raw) || raw || {};
    const payload = {
      category: normalizeStr(category),
      form: normalizeStr(form),
      lastEditedISO: normalizeStr(lastEditedISO),
      layout: layout
    };
    return hashString(stableSerialize(payload));
  }catch(e){
    return hashString(String(Date.now()) + Math.random());
  }
}

function normalizeImportedRecord(raw){
  if(!raw || typeof raw !== 'object') return null;
  const layout = extractLayout(raw);
  if(!layout) return null;

  const header = (layout.header && typeof layout.header === 'object') ? layout.header : {};
  const metaRaw = (raw.meta && typeof raw.meta === 'object') ? raw.meta : {};
  const metaLayout = (layout.meta && typeof layout.meta === 'object') ? layout.meta : {};

  const category = normalizeStr(raw.category || metaRaw.category || metaLayout.category || '');
  const form = normalizeStr(raw.form || raw.name || metaRaw.name || metaRaw.form || metaLayout.name || metaLayout.form || '');
  if(!category || !form) return null;

  const tagCode = normalizeStr(raw.tag || raw.code || metaRaw.tag || metaRaw.code || metaLayout.tag || metaLayout.code || '');
  const lastEditedISO = normalizeStr(
    raw.lastEditedISO ||
    raw.lastEdited ||
    metaRaw.inspectionLastEditedAtISO ||
    metaLayout.inspectionLastEditedAtISO ||
    header.lastEdited ||
    nowISO()
  );

  return {
    id: makeId(),
    category,
    form,
    lastEditedISO,
    fingerprint: (tagCode ? tagCode : computeFingerprint(category, form, lastEditedISO, raw)),
    raw
  };
}

function recordToTemplate(rec, existingTpl){
  const id = normalizeStr(rec?.id) || normalizeStr(existingTpl?.id) || makeId();
  const createdAt = normalizeStr(existingTpl?.createdAt) || nowISO();
  const updatedAt = nowISO();
  const category = normalizeStr(rec?.category || existingTpl?.category || '');
  const name = normalizeStr(rec?.form || existingTpl?.name || '');
  const code = normalizeStr(rec?.fingerprint || existingTpl?.code || '');
  const data = (rec && rec.raw && typeof rec.raw === 'object') ? rec.raw : ((existingTpl && existingTpl.data && typeof existingTpl.data === 'object') ? existingTpl.data : (rec?.raw || rec || {}));
  return { id, name, category, code, createdAt, updatedAt, data };
}

function toISOFromAny(v){
  if(!v) return '';
  if(typeof v === 'string') return v;
  if(v instanceof Date) return v.toISOString();
  try{
    if(typeof v.toDate === 'function'){
      const d = v.toDate();
      if(d instanceof Date && !isNaN(d.getTime())) return d.toISOString();
    }
  }catch(_){}
  try{
    const d2 = new Date(v);
    if(!isNaN(d2.getTime())) return d2.toISOString();
  }catch(_){}
  return '';
}

function templateToRecord(tpl){
  const id = normalizeStr(tpl?.id) || makeId();
  const category = normalizeStr(tpl?.category || '');
  const form = normalizeStr(tpl?.name || '');
  const fingerprint = normalizeStr(tpl?.code || '');
  const raw = (tpl && tpl.data && typeof tpl.data === 'object') ? tpl.data : {};
  const lastEditedISO =
    normalizeStr(raw?.lastEditedISO || raw?.lastEdited) ||
    normalizeStr(toISOFromAny(tpl?.updatedAtTs) || toISOFromAny(tpl?.updatedAt) || toISOFromAny(tpl?.createdAt)) ||
    nowISO();
  return { id, category, form, lastEditedISO, fingerprint, raw };
}

function ensureDbShape(items){
  let changed = false;
  const out = [];

  for(const it of (Array.isArray(items) ? items : [])){
    if(!it || typeof it !== 'object') continue;

    if(('category' in it) || ('form' in it) || ('raw' in it)){
      const obj = { ...it };

      if(!obj.id){ obj.id = makeId(); changed = true; }

      if(!obj.raw){
        const snap = { ...obj };
        delete snap.raw;
        obj.raw = snap;
        changed = true;
      }

      if(!obj.lastEditedISO){
        obj.lastEditedISO = nowISO();
        changed = true;
      }

      if(!obj.fingerprint){
        obj.fingerprint = computeFingerprint(obj.category || '', obj.form || '', obj.lastEditedISO || '', obj.raw || obj);
        changed = true;
      }

      out.push(obj);
      continue;
    }

    const wrapped = normalizeImportedRecord(it);
    if(wrapped){ out.push(wrapped); changed = true; }
  }

  const seen = new Set();
  const unique = [];
  for(const it of out){
    const fp = it && it.fingerprint ? String(it.fingerprint) : '';
    if(fp && seen.has(fp)){ changed = true; continue; }
    if(fp) seen.add(fp);
    unique.push(it);
  }

  return { items: unique, changed };
}

function assertFirestoreReady(){
  if(!__fire.db || !__fire.col) throw new Error('Firestore no inicializado.');
}

async function fetchAllInspections(){
  assertFirestoreReady();
  const snap = await __fire.db.collection(INS_COLLECTION).get();
  const out = [];
  snap.forEach(doc=>{
    const d = doc.data() || {};
    if(!d.id) d.id = doc.id;
    out.push(d);
  });
  return out;
}

async function fetchLatestInspections(limit){
  assertFirestoreReady();
  const lim = Math.max(1, Number(limit||200));
  try{
    return await __fire.db.collection(INS_COLLECTION).orderBy('updatedAtTs', 'desc').limit(lim).get().then(snap=>{
      const out=[]; snap.forEach(doc=>{ const d=doc.data()||{}; if(!d.id) d.id=doc.id; out.push(d); }); return out;
    });
  }catch(e0){
    try{
      return await __fire.db.collection(INS_COLLECTION).orderBy('updatedAt', 'desc').limit(lim).get().then(snap=>{
        const out=[]; snap.forEach(doc=>{ const d=doc.data()||{}; if(!d.id) d.id=doc.id; out.push(d); }); return out;
      });
    }catch(e1){
      try{
        return await __fire.db.collection(INS_COLLECTION).orderBy('createdAt', 'desc').limit(lim).get().then(snap=>{
          const out=[]; snap.forEach(doc=>{ const d=doc.data()||{}; if(!d.id) d.id=doc.id; out.push(d); }); return out;
        });
      }catch(e2){
        return await fetchAllInspections();
      }
    }
  }
}

async function fetchInspectionsByCode(code){
  assertFirestoreReady();
  const c = String(code||'').trim();
  if(!c) return [];
  const snap = await __fire.db.collection(INS_COLLECTION).where('code', '==', c).get();
  const out = [];
  snap.forEach(doc=>{
    const d = doc.data() || {};
    if(!d.id) d.id = doc.id;
    out.push(d);
  });
  return out;
}

async function upsertInspectionRaw(raw){
  assertFirestoreReady();
  if(!raw || typeof raw !== 'object') throw new Error('invalid_payload');
  const id = String(raw.id || makeId());
  const createdAt = normalizeStr(raw.createdAt) || nowISO();
  const payload = {
    ...raw,
    id,
    createdAt,
    updatedAt: nowISO(),
    updatedAtTs: firebase.firestore.FieldValue.serverTimestamp()
  };
  await __fire.db.collection(INS_COLLECTION).doc(id).set(payload, { merge:true });
  return id;
}

async function deleteAllInspections(){
  assertFirestoreReady();
  const snap = await __fire.db.collection(INS_COLLECTION).get();
  const docs = [];
  snap.forEach(d=>docs.push(d));
  let i = 0;
  while(i < docs.length){
    const chunk = docs.slice(i, i+400);
    const batch = __fire.db.batch();
    for(const d of chunk) batch.delete(d.ref);
    await batch.commit();
    i += chunk.length;
  }
  return true;
}

async function findByCode(code){
  assertFirestoreReady();
  const c = normalizeStr(code);
  if(!c) return null;
  const q = await __fire.col.where('code', '==', c).limit(1).get();
  if(q.empty) return null;
  const doc = q.docs[0];
  return { id: doc.id, ...(doc.data() || {}) };
}

async function loadDB(){
  const rows = await fetchLatestInspections(200);
  const records = [];
  for(const raw of rows){
    const base = (raw && raw.data && typeof raw.data==='object') ? raw.data : raw;
    const rec = normalizeImportedRecord(base);
    if(rec){
      rec.id = String(raw.id || rec.id);
      rec.fingerprint = normalizeStr(raw.code || rec.fingerprint);
      rec.lastEditedISO = normalizeStr(rec.lastEditedISO || toISOFromAny(raw.updatedAtTs) || raw.updatedAt || raw.createdAt || nowISO());
      records.push(rec);
    }
  }
  const shaped = ensureDbShape(records);
  __dbCache = shaped.items;
  __cacheLoaded = true;
  return __dbCache;
}

function getCache(){ return Array.isArray(__dbCache) ? __dbCache : []; }

async function refreshCache(){ await loadDB(); }

function parseDateSafe(v){
  if(!v) return null;
  const d = new Date(v);
  if(isNaN(d.getTime())) return null;
  return d;
}

function formatDateDDMMYYYY_HHMM(input){
  const d = (input instanceof Date) ? input : parseDateSafe(input);
  if(!d) return '—';
  const pad = (n)=> String(n).padStart(2,'0');
  const dd = pad(d.getDate());
  const mm = pad(d.getMonth()+1);
  const yyyy = d.getFullYear();
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}

function refreshCategoryOptions(){
  const sel = document.getElementById('advCategory');
  if(!sel) return;

  const current = sel.value || '';
  const db = getCache();
  const cats = [...new Set(db.map(x => normalizeStr(x?.category)).filter(Boolean))]
    .sort((a,b)=> a.localeCompare(b, 'es', { sensitivity: 'base' }));

  sel.innerHTML = `<option value="">(Todas)</option>` + cats.map(c=>{
    const safe = c.replaceAll('"','&quot;');
    return `<option value="${safe}">${safe}</option>`;
  }).join('');

  if(current && cats.includes(current)) sel.value = current;
}

function applyFilters(db){
  const q = normalizeLower((document.getElementById('histSearch')||{}).value);
  const cat = normalizeStr((document.getElementById('advCategory')||{}).value);
  const formLike = normalizeLower((document.getElementById('advForm')||{}).value);

  const fromVal = (document.getElementById('advFrom')||{}).value;
  const toVal = (document.getElementById('advTo')||{}).value;

  const from = parseDateSafe(fromVal ? fromVal : null);
  const to = parseDateSafe(toVal ? toVal : null);

  const toMs = to ? to.getTime() : null;
  const fromMs = from ? from.getTime() : null;

  return db.filter(e=>{
    if(!e) return false;

    if(q){
      try{
        if(!JSON.stringify(e).toLowerCase().includes(q)) return false;
      }catch(_){}
    }

    if(cat && normalizeStr(e.category) !== cat) return false;

    if(formLike){
      const f = normalizeLower(e.form);
      if(!f.includes(formLike)) return false;
    }

    if(fromMs !== null || toMs !== null){
      const d = parseDateSafe(e.lastEditedISO);
      if(!d) return false;
      const t = d.getTime();
      if(fromMs !== null && t < fromMs) return false;
      if(toMs !== null && t > toMs) return false;
    }

    return true;
  });
}

function setPage(p){
  __page = Number(p) || 1;
  renderList();
}

async function renderList(){
  const wrap = document.getElementById('histList');
  if(!wrap) return;

  if(!__cacheLoaded){
    wrap.innerHTML = '';
    const div = document.createElement('div');
    div.className = 'histEmpty';
    div.textContent = 'Conectando a Firestore…';
    wrap.appendChild(div);

    try{
      await refreshCache();
    }catch(e){
      wrap.innerHTML = '';
      const err = document.createElement('div');
      err.className = 'histEmpty';
      err.textContent = 'No se pudo conectar a Firestore. Revisa la conexión y la configuración.';
      wrap.appendChild(err);
      return;
    }
  }

  refreshCategoryOptions();

  const db = getCache();
  const filtered = applyFilters(db);

  wrap.innerHTML = '';
  if(filtered.length === 0){
    const div = document.createElement('div');
    div.className = 'histEmpty';
    div.textContent = db.length === 0 ? 'No hay inspecciones guardadas todavía.' : 'No hay inspecciones que coincidan con los filtros.';
    wrap.appendChild(div);
    return;
  }

  const itemsSorted = filtered.slice().sort((a,b)=> String(b.lastEditedISO||'').localeCompare(String(a.lastEditedISO||'')));

  const total = itemsSorted.length;
  const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  if(__page > totalPages) __page = totalPages;
  if(__page < 1) __page = 1;

  const start = (__page - 1) * PAGE_SIZE;
  const end = Math.min(start + PAGE_SIZE, total);
  const pageItems = itemsSorted.slice(start, end);

  const tableWrap = document.createElement('div');
  tableWrap.className = 'tableWrap';

  const table = document.createElement('table');
  table.className = 'histTable';
  table.innerHTML = `
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Categoría</th>
        <th>Formulario</th>
        <th>PDF</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;

  const tbody = table.querySelector('tbody');
  for(const e of pageItems){
    const tr = document.createElement('tr');
    const safeId = String(e.id || '');
    tr.innerHTML = `
      <td>${formatDateDDMMYYYY_HHMM(e.lastEditedISO)}</td>
      <td>${(e.category || '—')}</td>
      <td>${(e.form || '—')}</td>
      <td><button type="button" class="primary" data-export-id="${safeId}">Exportar</button></td>
    `;
    tbody.appendChild(tr);
  }

  tableWrap.appendChild(table);
  wrap.appendChild(tableWrap);

  tableWrap.addEventListener('click', (ev)=>{
    const btn = ev.target && ev.target.closest ? ev.target.closest('button[data-export-id]') : null;
    if(!btn) return;
    const id = btn.getAttribute('data-export-id') || '';
    if(id) exportRecordPDF(id);
  }, { passive:true });

  const pager = document.createElement('div');
  pager.className = 'pager';
  pager.innerHTML = `
    <div class="meta">
      Mostrando <span class="pill">${start + 1}–${end}</span> de <span class="pill">${total}</span> resultados
      · Página <span class="pill">${__page}</span> / <span class="pill">${totalPages}</span>
    </div>
    <div class="controls">
      <button type="button" data-page="1" ${__page===1?'disabled':''}>⏮ Primera</button>
      <button type="button" data-page="${__page-1}" ${__page===1?'disabled':''}>◀ Anterior</button>
      <button type="button" data-page="${__page+1}" ${__page===totalPages?'disabled':''}>Siguiente ▶</button>
      <button type="button" data-page="${totalPages}" ${__page===totalPages?'disabled':''}>Última ⏭</button>
    </div>
  `;
  wrap.appendChild(pager);

  pager.addEventListener('click', (ev)=>{
    const b = ev.target && ev.target.closest ? ev.target.closest('button[data-page]') : null;
    if(!b || b.disabled) return;
    const p = Number(b.getAttribute('data-page') || '1') || 1;
    setPage(p);
  }, { passive:true });
}

async function loadAllFromCloud(){
  if(!confirm('Esto cargará TODAS las inspecciones desde Firestore (puede tardar). ¿Continuar?')) return;
  const wrap = document.getElementById('histList');
  try{
    if(wrap) wrap.innerHTML = '<div class="histEmpty">Cargando todas desde Firestore…</div>';
    const rows = await fetchAllInspections();
    const records = [];
    for(const raw of rows){
      const base = (raw && raw.data && typeof raw.data==='object') ? raw.data : raw;
      const rec = normalizeImportedRecord(base);
      if(rec){
        rec.id = String(raw.id || rec.id);
        rec.fingerprint = normalizeStr(raw.code || rec.fingerprint);
        rec.lastEditedISO = normalizeStr(rec.lastEditedISO || toISOFromAny(raw.updatedAtTs) || raw.updatedAt || raw.createdAt || nowISO());
        records.push(rec);
      }
    }
    __dbCache = ensureDbShape(records).items;
    __cacheLoaded = true;
    __loadedAll = true;
    __page = 1;
    refreshCategoryOptions();
    await renderList();
  }catch(e){
    alert('No se pudo cargar todo.\n' + (e && (e.message||e.toString()) ? (e.message||e.toString()) : ''));
  }
}

async function runSearch(){
  const q = normalizeStr((document.getElementById('histSearch')||{}).value);
  if(!q){
    __cacheLoaded = false;
    __loadedAll = false;
    __page = 1;
    await renderList();
    return;
  }

  const wrap = document.getElementById('histList');
  try{
    if(wrap) wrap.innerHTML = '<div class="histEmpty">Buscando en Firestore…</div>';

    const rows = await fetchInspectionsByCode(q);

    if(rows && rows.length){
      const records = [];
      for(const raw of rows){
        const base = (raw && raw.data && typeof raw.data==='object') ? raw.data : raw;
        const rec = normalizeImportedRecord(base);
        if(rec){
          rec.id = String(raw.id || rec.id);
          rec.fingerprint = normalizeStr(raw.code || rec.fingerprint || q);
          rec.lastEditedISO = normalizeStr(rec.lastEditedISO || toISOFromAny(raw.updatedAtTs) || raw.updatedAt || raw.createdAt || nowISO());
          records.push(rec);
        }
      }
      __dbCache = ensureDbShape(records).items;
      __cacheLoaded = true;
      __page = 1;
      refreshCategoryOptions();
      await renderList();
      return;
    }

    if(!__loadedAll){
      const latest = await fetchLatestInspections(200);
      const records = [];
      for(const raw of latest){
        const base = (raw && raw.data && typeof raw.data==='object') ? raw.data : raw;
        const rec = normalizeImportedRecord(base);
        if(rec){
          rec.id = String(raw.id || rec.id);
          rec.fingerprint = normalizeStr(raw.code || rec.fingerprint);
          rec.lastEditedISO = normalizeStr(rec.lastEditedISO || toISOFromAny(raw.updatedAtTs) || raw.updatedAt || raw.createdAt || nowISO());
          records.push(rec);
        }
      }
      __dbCache = ensureDbShape(records).items;
      __cacheLoaded = true;
      __page = 1;
      refreshCategoryOptions();
      await renderList();
      const filtered = applyFilters(getCache());
      if(!filtered.length){
        if(confirm('No se encontró nada por código exacto ni en las últimas 200. ¿Quieres CARGAR TODAS para buscar por texto en todo el histórico?')){
          await loadAllFromCloud();
        }
      }
      return;
    }

    await renderList();
  }catch(e){
    alert('No se pudo buscar.\n' + (e && (e.message||e.toString()) ? (e.message||e.toString()) : ''));
  }
}

async function clearDB(){
  if(!confirm('¿Vaciar por completo la base de datos en la nube (Firestore)?')) return;
  try{
    await deleteAllInspections();
    __page = 1;
    __loadedAll = false;
    await refreshCache();
    refreshCategoryOptions();
    await renderList();
  }catch(e){
    alert('No se pudo vaciar la base de datos.');
  }
}

function resetToFirstPageAndRender(){
  __page = 1;
  renderList();
}

function clearAdvancedFilters(){
  const a = document.getElementById('advCategory'); if(a) a.value = '';
  const b = document.getElementById('advForm'); if(b) b.value = '';
  const c = document.getElementById('advFrom'); if(c) c.value = '';
  const d = document.getElementById('advTo'); if(d) d.value = '';
  const e = document.getElementById('histSearch'); if(e) e.value = '';
  __page = 1;
  renderList();
}

function exportStamp(date){
  const d = date instanceof Date ? date : new Date();
  const pad = (n)=> String(n).padStart(2,'0');
  const y = d.getFullYear();
  const m = pad(d.getMonth()+1);
  const da = pad(d.getDate());
  const h = pad(d.getHours());
  const mi = pad(d.getMinutes());
  const s = pad(d.getSeconds());
  return `${y}-${m}-${da}_${h}-${mi}-${s}`;
}

function makeSafeName(name, fallback){
  const out = normalizeStr(name)
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-zA-Z0-9_\-]+/g,'_')
    .replace(/_+/g,'_')
    .replace(/^_+|_+$/g,'');
  return out || fallback || 'Archivo';
}

let __exportFrame = null;

async function getExportFrame(){
  if(__exportFrame && __exportFrame.contentWindow && __exportFrame.contentDocument) return __exportFrame;

  const frame = document.createElement('iframe');
  frame.style.position = 'fixed';
  frame.style.left = '-10000px';
  frame.style.top = '0';
  frame.style.width = '1024px';
  frame.style.height = '768px';
  frame.style.opacity = '0';
  frame.style.pointerEvents = 'none';
  frame.setAttribute('aria-hidden', 'true');
  document.body.appendChild(frame);

  const doc = frame.contentDocument;
  doc.open();
  doc.write(`<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Export PDF</title>
<style>
  :root{
    --page-bg:#ffffff;
    --border:#000000;
    --shadow: rgba(0,0,0,.12);
    --header-bg:#ffffff;
    --header-text:#000000;
    --section-bg:#e6e6e6;
    --section-text:#000000;
    --body-bg:#ffffff;
    --body-text:#000000;
  }
  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background:#f5f5f5;
    color:var(--body-text);
  }
  .page{
    width: 900px;
    max-width: 100%;
    margin: 22px auto;
    background: var(--page-bg);
    border: 1px solid var(--border);
    box-shadow: 0 10px 30px var(--shadow);
    padding: 18px 18px 22px;
  }
  .doc-header{
    display:grid;
    grid-template-columns: 120px 1fr 190px;
    gap: 14px;
    align-items:center;
    padding: 12px;
    border: 1px solid var(--border);
    background: var(--header-bg);
    color: var(--header-text);
  }
  .logo{
    width: 120px;
    height: 70px;
    border: 1px solid var(--border);
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  .header-title{
    font-weight: 900;
    font-size: 18px;
    line-height: 1.15;
  }
  .header-subtitle{
    margin-top: 4px;
    font-size: 13px;
    opacity:.9;
  }
  .header-meta{
    text-align:right;
    font-size: 12px;
    line-height: 1.35;
  }
  .muted{ opacity:.75; }
  #fieldsMount{ margin-top: 10px; }
  .field{
    border: 1px solid var(--border);
    margin-top: 10px;
    background: var(--body-bg);
  }
  .field-head{
    padding: 8px 10px;
    background: var(--section-bg);
    color: var(--section-text);
    border-bottom: 1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }
  .field-head .title{
    font-weight: 900;
    font-size: 13px;
  }
  .field-body{
    padding: 10px;
    font-size: 13px;
  }
  input[type="text"], input[type="number"], input[type="date"], textarea, select{
    width:100%;
    border: 1px solid var(--border);
    font: inherit;
    background:#fff;
    line-height: 1.35;
    padding: 9px 10px 11px;
  }
  input[type="text"], input[type="number"], input[type="date"], select{
    height: 34px;
  }
  textarea{
    min-height: 90px;
    resize: vertical;
    padding-bottom: 14px;
  }
  .checkline{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .photoGrid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }
  .photoItem{
    border: 1px solid var(--border);
    padding: 6px;
    background:#fff;
  }
  .photoItem img{
    width:100%;
    height:160px;
    object-fit:cover;
    display:block;
    border: 1px solid #ddd;
  }
  body.exporting .uiOnly{ display:none !important; }
  @media (max-width: 560px){
    .doc-header{ grid-template-columns: 1fr; text-align:left; }
    .header-meta{ text-align:left; }
  }
</style>
</head>
<body>
<div id="capture" class="page">
  <div id="docHeader" class="doc-header">
    <div class="logo" id="logoBox"></div>
    <div class="header-text">
      <div id="docTitle" class="header-title"></div>
      <div id="docSubtitle" class="header-subtitle"></div>
    </div>
    <div class="header-meta">
      <div class="muted">Última edición</div>
      <div id="lastEdited">—</div>
    </div>
  </div>
  <div id="fieldsMount"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"><\/script>
<script>
  function escapeHTML(str){
    return String(str ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }
  function normalize(s){ return String(s ?? '').trim().toLowerCase(); }

  function fieldHTML(d, idx){
    const type = normalize(d.type) || 'text';
    const title = (d.title ?? '').toString();
    const config = (d.config && typeof d.config==='object') ? d.config : {};

    if(type === 'text'){
      const v = (d.value ?? '').toString();
      return \`
        <div class="field" data-type="text" data-idx="\${idx}">
          <div class="field-head"><div class="title">\${escapeHTML(title)}</div></div>
          <div class="field-body textline"><input type="text" value="\${escapeHTML(v)}" /></div>
        </div>
      \`;
    }

    if(type === 'textarea'){
      const v = (d.value ?? '').toString();
      return \`
        <div class="field" data-type="textarea" data-idx="\${idx}">
          <div class="field-head"><div class="title">\${escapeHTML(title)}</div></div>
          <div class="field-body"><textarea>\${escapeHTML(v)}</textarea></div>
        </div>
      \`;
    }

    if(type === 'number'){
      const v = (d.value ?? '').toString();
      return \`
        <div class="field" data-type="number" data-idx="\${idx}">
          <div class="field-head"><div class="title">\${escapeHTML(title)}</div></div>
          <div class="field-body"><input type="number" value="\${escapeHTML(v)}" /></div>
        </div>
      \`;
    }

    if(type === 'date'){
      const v = (d.value ?? '').toString();
      return \`
        <div class="field" data-type="date" data-idx="\${idx}">
          <div class="field-head"><div class="title">\${escapeHTML(title)}</div></div>
          <div class="field-body"><input type="date" value="\${escapeHTML(v)}" /></div>
        </div>
      \`;
    }

    if(type === 'select'){
      const v = (d.value ?? '').toString();
      const options = Array.isArray(config.options) ? config.options : [];
      const optsHTML = options.map(o=>{
        const val = (o ?? '').toString();
        const sel = val === v ? 'selected' : '';
        return \`<option \${sel} value="\${escapeHTML(val)}">\${escapeHTML(val)}</option>\`;
      }).join('');
      return \`
        <div class="field" data-type="select" data-idx="\${idx}">
          <div class="field-head"><div class="title">\${escapeHTML(title)}</div></div>
          <div class="field-body"><select>\${optsHTML}</select></div>
        </div>
      \`;
    }

    if(type === 'check'){
      const v = !!d.value;
      const label = (config.label ?? 'Sí/No').toString();
      const checked = v ? 'checked' : '';
      return \`
        <div class="field" data-type="check" data-idx="\${idx}">
          <div class="field-head"><div class="title">\${escapeHTML(title)}</div></div>
          <div class="field-body">
            <label class="checkline"><input type="checkbox" \${checked} /><span>\${escapeHTML(label)}</span></label>
          </div>
        </div>
      \`;
    }

    if(type === 'photos'){
      const images = Array.isArray(d.images) ? d.images : [];
      const grid = images.map((src, i)=>{
        const safe = (src ?? '').toString();
        return \`<div class="photoItem"><img src="\${escapeHTML(safe)}" alt="Foto \${i+1}" /></div>\`;
      }).join('');
      return \`
        <div class="field" data-type="photos" data-idx="\${idx}">
          <div class="field-head"><div class="title">\${escapeHTML(title)}</div></div>
          <div class="field-body"><div class="photoGrid">\${grid || '<div class="muted">—</div>'}</div></div>
        </div>
      \`;
    }

    const v = (d.value ?? '').toString();
    return \`
      <div class="field" data-type="unknown" data-idx="\${idx}">
        <div class="field-head"><div class="title">\${escapeHTML(title || type)}</div></div>
        <div class="field-body">\${escapeHTML(v)}</div>
      </div>
    \`;
  }

  function applyTheme(theme){
    if(!theme || typeof theme !== 'object') return;
    const root = document.documentElement;
    const map = {
      border: '--border',
      bodyBg: '--body-bg',
      bodyText: '--body-text',
      headerBg: '--header-bg',
      headerText: '--header-text',
      sectionBg: '--section-bg',
      sectionText: '--section-text',
      pageBg: '--page-bg'
    };
    for(const k in map){
      if(theme[k]) root.style.setProperty(map[k], String(theme[k]));
    }
  }

  function renderLayout(layout){
    if(!layout || typeof layout !== 'object') return;
    const header = (layout.header && typeof layout.header==='object') ? layout.header : {};
    const meta = (layout.meta && typeof layout.meta==='object') ? layout.meta : {};

    applyTheme(layout.theme);

    const title = (header.title ?? meta.name ?? meta.form ?? '').toString() || '—';
    const subtitle = (header.subtitle ?? meta.subtitle ?? meta.category ?? '').toString() || '';
    const lastEdited = (header.lastEdited ?? '').toString() || '—';
    const logo = (header.logo ?? '').toString();

    document.getElementById('docTitle').textContent = title;
    document.getElementById('docSubtitle').textContent = subtitle;
    document.getElementById('lastEdited').textContent = lastEdited;

    const logoBox = document.getElementById('logoBox');
    logoBox.style.backgroundImage = logo ? \`url("\${logo}")\` : 'none';

    const mount = document.getElementById('fieldsMount');
    const fields = Array.isArray(layout.fields) ? layout.fields : [];
    mount.innerHTML = fields.map((d,i)=>fieldHTML(d,i)).join('');
  }

  async function saveSingleFile(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename || 'informe.pdf';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 2500);
  }

  async function exportPDFLikeInspector(filename){
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });

    const pageW = 210;
    const pageH = 297;
    const margin = 10;
    const contentW = pageW - margin*2;
    const contentH = pageH - margin*2;

    document.body.classList.add('exporting');

    async function renderEl(element){
      return await html2canvas(element, {
        scale: 2,
        backgroundColor: '#ffffff',
        useCORS: true,
        scrollX: 0,
        scrollY: -window.scrollY,
        onclone: (doc)=>{
          const cap = doc.getElementById('capture');
          if(cap){ cap.style.boxShadow = 'none'; cap.style.margin = '0'; }
          const ui = doc.querySelectorAll('.uiOnly');
          for(const el of ui) el.style.display = 'none';
        }
      });
    }

    try{
      const header = document.getElementById('docHeader');
      const fields = Array.from(document.querySelectorAll('#capture .field'));
      const blocks = [header, ...fields];

      let cursorY = margin;

      for(const block of blocks){
        const canvas = await renderEl(block);
        const imgData = canvas.toDataURL('image/jpeg', 0.95);

        let blockWmm = contentW;
        let blockHmm = (canvas.height * blockWmm) / canvas.width;

        if(blockHmm > contentH){
          const scaleFactor = contentH / blockHmm;
          blockWmm = blockWmm * scaleFactor;
          blockHmm = contentH;
        }

        if(cursorY + blockHmm > (pageH - margin)){
          pdf.addPage();
          cursorY = margin;
        }

        const x = margin + (contentW - blockWmm) / 2;
        pdf.addImage(imgData, 'JPEG', x, cursorY, blockWmm, blockHmm);
        cursorY += blockHmm + 2;
      }

      const pdfBlob = pdf.output('blob');
      await saveSingleFile(pdfBlob, filename);
    } finally {
      document.body.classList.remove('exporting');
    }
  }

  window.renderAndExport = async function(layout, filename){
    renderLayout(layout);
    await new Promise(r=>setTimeout(r, 30));
    await exportPDFLikeInspector(filename);
  };
<\/script>
</body>
</html>`);
  doc.close();

  await new Promise((resolve, reject)=>{
    const start = Date.now();
    (function tick(){
      try{
        const w = frame.contentWindow;
        if(w && w.jspdf && w.html2canvas && typeof w.renderAndExport === 'function') return resolve();
      }catch(_){}
      if(Date.now() - start > 10000) return reject(new Error('No se pudieron cargar librerías de exportación.'));
      setTimeout(tick, 50);
    })();
  });

  __exportFrame = frame;
  return frame;
}

async function exportRecordPDF(id){
  let rec = getCache().find(x => x && x.id === id);

  if(!rec){
    try{
      assertFirestoreReady();
      const doc = await __fire.col.doc(String(id)).get();
      if(doc.exists) rec = templateToRecord({ id: doc.id, ...(doc.data() || {}) });
    }catch(_){}
  }

  if(!rec){
    alert('No se encontró el registro.');
    return;
  }

  const raw = rec.raw || rec;
  const layout = extractLayout(raw);
  if(!layout){
    alert('El registro no contiene un layout válido para exportar.');
    return;
  }

  layout.meta = (layout.meta && typeof layout.meta==='object') ? layout.meta : {};
  layout.meta.category = layout.meta.category || rec.category || '';
  layout.meta.name = layout.meta.name || rec.form || '';

  layout.header = (layout.header && typeof layout.header==='object') ? layout.header : {};
  if(!layout.header.lastEdited) layout.header.lastEdited = rec.lastEditedISO || nowISO();

  const safeCat = makeSafeName(rec.category || layout.meta.category || 'Categoria', 'Categoria');
  const safeForm = makeSafeName(rec.form || layout.meta.name || 'Formulario', 'Formulario');
  const filename = `informe_${safeCat}__${safeForm}__${exportStamp(new Date())}.pdf`;

  try{
    const frame = await getExportFrame();
    await frame.contentWindow.renderAndExport(layout, filename);
  }catch(e){
    alert('No se pudo exportar el PDF.');
  }
}

async function initFirestore(){
  if(!firebase.apps || !firebase.apps.length) __fire.app = firebase.initializeApp(firebaseConfig);
  else __fire.app = firebase.app();
  __fire.db = firebase.firestore();
  __fire.col = __fire.db.collection(COLLECTION_NAME);
}

async function initApp(){
  await initFirestore();
  await renderList();

  const hs = document.getElementById('histSearch');
  const advCategory = document.getElementById('advCategory');
  const advForm = document.getElementById('advForm');
  const advFrom = document.getElementById('advFrom');
  const advTo = document.getElementById('advTo');

  const btnBuscar = document.getElementById('btnBuscar');
  const btnCargarTodas = document.getElementById('btnCargarTodas');
  const btnLimpiar = document.getElementById('btnLimpiar');

  if(btnBuscar) btnBuscar.addEventListener('click', ()=>{ runSearch(); }, { passive:true });
  if(btnCargarTodas) btnCargarTodas.addEventListener('click', ()=>{ loadAllFromCloud(); }, { passive:true });
  if(btnLimpiar) btnLimpiar.addEventListener('click', ()=>{ clearAdvancedFilters(); }, { passive:true });

  const reRender = ()=> resetToFirstPageAndRender();
  if(hs){
    hs.addEventListener('input', reRender, { passive:true });
    hs.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); runSearch(); } });
  }
  if(advCategory) advCategory.addEventListener('change', reRender, { passive:true });
  if(advForm) advForm.addEventListener('input', reRender, { passive:true });
  if(advFrom) advFrom.addEventListener('change', reRender, { passive:true });
  if(advTo) advTo.addEventListener('change', reRender, { passive:true });
}

window.findAndFocusByCode = async function(code){
  try{
    const tpl = await findByCode(code);
    if(!tpl){
      alert('No se encontró ninguna inspección con ese TAG/código.');
      return null;
    }
    const rec = templateToRecord(tpl);
    await refreshCache();
    const hs = document.getElementById('histSearch');
    if(hs) hs.value = String(code);
    __page = 1;
    await renderList();
    return rec;
  }catch(e){
    alert('No se pudo buscar por TAG/código.');
    return null;
  }
};

function exportJSON(){
  alert('Modo nube: la base de datos lee directamente desde Firestore.\n\nSi necesitas una copia, usa la exportación PDF o añade una función de backup server-side.');
}

async function importJsonFiles(){
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'application/json,.json';
  inp.multiple = true;

  inp.onchange = async ()=>{
    const files = Array.from(inp.files || []);

    try{ if(!__cacheLoaded) await refreshCache(); }catch(_){}
    const db = getCache();
    const seen = new Set(db.map(x=>String(x?.fingerprint||'')).filter(Boolean));

    let importedCount = 0;

    for(const f of files){
      try{
        const txt = await f.text();
        const obj = JSON.parse(txt);

        if(obj && typeof obj === 'object' && obj.format === 'inspector_inspections_v1' && Array.isArray(obj.inspections)){
          for(const one of obj.inspections){
            const rec = normalizeImportedRecord(one);
            if(rec && rec.fingerprint && !seen.has(String(rec.fingerprint))){
              rec.id = rec.id || makeId();
              const tpl = recordToTemplate(rec, null);
              const existing = await findByCode(tpl.code);
              if(existing && existing.id){
                tpl.id = existing.id;
                tpl.createdAt = normalizeStr(existing.createdAt) || tpl.createdAt;
              }
              await upsertInspectionRaw(tpl);
              seen.add(String(rec.fingerprint));
              importedCount++;
            }
          }
          continue;
        }

        const rec = normalizeImportedRecord(obj);
        if(rec && rec.fingerprint && !seen.has(String(rec.fingerprint))){
          rec.id = rec.id || makeId();
          const tpl = recordToTemplate(rec, null);
          const existing = await findByCode(tpl.code);
          if(existing && existing.id){
            tpl.id = existing.id;
            tpl.createdAt = normalizeStr(existing.createdAt) || tpl.createdAt;
          }
          await upsertInspectionRaw(tpl);
          seen.add(String(rec.fingerprint));
          importedCount++;
        }
      }catch(_){}
    }

    await refreshCache();
    __page = 1;
    refreshCategoryOptions();
    await renderList();

    if(importedCount === 0) alert('No se importaron nuevos registros (puede que ya existan por TAG/código).');
  };

  inp.click();
}

function clearAll(){ return clearDB(); }

try{
  window.refreshCache = refreshCache;
  window.runSearch = runSearch;
  window.loadAllFromCloud = loadAllFromCloud;
  window.clearDB = clearDB;
  window.clearAll = clearAll;
  window.exportJSON = exportJSON;
  window.importJsonFiles = importJsonFiles;
}catch(_){}

initApp();
</script>
</body>
</html>
