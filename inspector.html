<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Inspector</title>
<style>
  :root{
    --page-bg:#ffffff;
    --border:#000000;
    --header-bg:#ffffff;
    --header-text:#000000;
    --section-bg:#e6e6e6;
    --section-text:#000000;
    --body-text:#000000;
    --w95-bg:#c0c0c0;
    --w95-light:#ffffff;
    --w95-dark:#808080;
    --w95-shadow:#404040;
    --w95-blue:#000080;
    --w95-hilite:#dfdfdf;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --container-max: 1200px;
    --pad: 10px;
    --page-padding: 10mm;
    --logo-w: 190px;
    --logo-h: 140px;
    --photo-w: 160px;
    --photo-h: 200px;
  }

  @page{ size:A4; margin:0; }

  html,body{height:100%}
  body{
    margin:0;
    font-family: "MS Sans Serif", Tahoma, Arial, Helvetica, sans-serif;
    background: var(--w95-bg);
    color: var(--body-text);
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }

  .topbar{
    position:sticky; top:0; z-index:50;
    background: var(--w95-bg);
    padding: calc(6px + var(--safe-top)) calc(8px + var(--safe-right)) 8px calc(8px + var(--safe-left));
    border-top:2px solid var(--w95-light);
    border-left:2px solid var(--w95-light);
    border-right:2px solid var(--w95-shadow);
    border-bottom:2px solid var(--w95-shadow);
  }
  .topbar::before{
    content:"Inspector";
    display:block;
    background: var(--w95-blue);
    color:#fff;
    font-weight:800;
    font-size:12px;
    letter-spacing:.2px;
    padding:6px 8px;
    margin:-6px -8px 8px -8px;
    border-bottom:1px solid #000;
  }
  .topbar .row{
    max-width:var(--container-max);
    margin:0 auto;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    background: var(--w95-bg);
    padding:10px;
    border-top:2px solid var(--w95-light);
    border-left:2px solid var(--w95-light);
    border-right:2px solid var(--w95-shadow);
    border-bottom:2px solid var(--w95-shadow);
  }

  .group{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .btn,
  .topbar button{
    border-top:2px solid var(--w95-light);
    border-left:2px solid var(--w95-light);
    border-right:2px solid var(--w95-shadow);
    border-bottom:2px solid var(--w95-shadow);
    background: var(--w95-bg);
    padding:10px 12px;
    font-weight:900;
    cursor:pointer;
    font-size:12px;
    font-family: inherit;
    color:#000;
    touch-action: manipulation;
  }
  .topbar button:active,
  .btn:active{
    border-top:2px solid var(--w95-shadow);
    border-left:2px solid var(--w95-shadow);
    border-right:2px solid var(--w95-light);
    border-bottom:2px solid var(--w95-light);
  }
  .btn.primary{ background: var(--w95-hilite); }
  .btn:disabled{ opacity:.5; cursor:not-allowed; }

  .statusline{
    max-width:var(--container-max);
    margin:10px auto 0;
    padding:12px;
    background:#ffffe1;
    border:1px solid #000;
    box-shadow: inset 1px 1px 0 #fff;
    font-size:12px;
    font-weight:900;
    line-height:1.35;
  }

  .ctaWrap{
    max-width:var(--container-max);
    margin:12px auto 0;
    padding:0 var(--pad);
  }
  .cta{
    width:100%;
    padding:18px 16px;
    font-size:18px;
    font-weight:900;
    letter-spacing:.4px;
    background: var(--w95-hilite);
    border-top:3px solid var(--w95-light);
    border-left:3px solid var(--w95-light);
    border-right:3px solid var(--w95-shadow);
    border-bottom:3px solid var(--w95-shadow);
    cursor:pointer;
    color:#000;
    touch-action: manipulation;
  }
  .cta:active{
    border-top:3px solid var(--w95-shadow);
    border-left:3px solid var(--w95-shadow);
    border-right:3px solid var(--w95-light);
    border-bottom:3px solid var(--w95-light);
  }

  .workspace{
    max-width:var(--container-max);
    margin:12px auto;
    padding:0 var(--pad) calc(20px + var(--safe-bottom));
  }

  .page{
    width:min(210mm, 100%);
    min-height:auto;
    margin:0 auto 14px auto;
    background: var(--page-bg);
    padding: var(--page-padding);
    border-top:2px solid var(--w95-light);
    border-left:2px solid var(--w95-light);
    border-right:2px solid var(--w95-shadow);
    border-bottom:2px solid var(--w95-shadow);
    box-shadow: inset 1px 1px 0 #fff, 0 6px 18px rgba(0,0,0,.12);
    box-sizing:border-box;
  }

  .doc-header{
    border:2px solid var(--border);
    background: var(--header-bg);
    color: var(--header-text);
    padding:10px;
    margin-bottom:12px;
    display:flex;
    gap:12px;
    align-items:stretch;
    break-inside:avoid;
    page-break-inside:avoid;
    box-sizing:border-box;
  }
  .logo{
    width:var(--logo-w);
    height:var(--logo-h);
    border:2px solid var(--border);
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    flex: 0 0 auto;
    box-sizing:border-box;
  }
  .logo img{
    width:100%;
    height:100%;
    object-fit:contain;
    display:block;
  }
  .header-text{
    flex:1 1 auto;
    min-width:0;
    display:flex;
    flex-direction:column;
    justify-content:center;
  }
  .header-title{
    font-size:18px;
    font-weight:900;
    margin:0 0 4px 0;
    line-height:1.15;
    word-break:break-word;
  }
  .header-subtitle{
    font-size:12px;
    font-weight:800;
    margin:0;
    opacity:.95;
    word-break:break-word;
  }
  .header-meta{
    flex: 0 0 auto;
    text-align:right;
    min-width:190px;
    font-size:11px;
    font-weight:900;
    line-height:1.2;
    word-break:break-word;
    display:flex;
    flex-direction:column;
    justify-content:center;
  }
  .header-meta .muted{
    opacity:.85;
    font-weight:800;
  }

  .field{
    border:2px solid var(--border);
    margin-bottom:12px;
    background:#fff;
    break-inside:avoid;
    page-break-inside:avoid;
    box-sizing:border-box;
  }
  .field-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    padding:8px;
    background: var(--section-bg);
    color: var(--section-text);
    border-bottom:2px solid var(--border);
    box-sizing:border-box;
  }
  .title{
    font-weight:900;
    font-size:14px;
    word-break:break-word;
    flex:1 1 auto;
    min-width:0;
  }
  .field-body{ padding:10px; box-sizing:border-box; }

  .textline input[type="text"]{
    width:100%;
    border:2px solid var(--border);
    padding:10px;
    font-size:16px;
    font-weight:500;
    box-sizing:border-box;
    color: var(--body-text);
    background:#fff;
    cursor:text;
  }
  textarea{
    width:100%;
    min-height:88px;
    resize:none;
    border:2px solid var(--border);
    padding:10px;
    font-size:16px;
    line-height:1.25;
    overflow:hidden;
    box-sizing:border-box;
    font-family: Arial, Helvetica, sans-serif;
    color: var(--body-text);
    background:#fff;
    cursor:text;
  }

  .opts{
    display:flex;
    flex-wrap:wrap;
    gap:16px;
    margin-bottom:10px;
    font-size:16px;
    color: var(--body-text);
  }
  .opts label{
    white-space:nowrap;
    font-weight:900;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .opts input[type="radio"]{ transform: scale(1.15); }

  .photos{
    display:grid;
    grid-template-columns:repeat(4, var(--photo-w));
    gap:10px;
    margin-top:10px;
    justify-content:start;
  }
  .photos img{
    width:var(--photo-w);
    height:var(--photo-h);
    object-fit:contain;
    border:2px solid var(--border);
    background:#fff;
    display:block;
    box-sizing:border-box;
  }

  .photo-slot{
    position:relative;
    width:var(--photo-w);
    height:var(--photo-h);
    border:2px solid var(--border);
    background:#fff;
    box-sizing:border-box;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .photo-slot img{
    border:none;
    width:100%;
    height:100%;
    object-fit:contain;
  }
  .photo-slot .ph{
    font-size:12px;
    font-weight:900;
    opacity:.7;
    padding:8px;
    text-align:center;
    line-height:1.2;
  }
  .photo-slot .slot-actions{
    position:absolute;
    left:6px;
    right:6px;
    bottom:6px;
    display:flex;
    gap:6px;
    justify-content:space-between;
    pointer-events:none;
  }
  .photo-slot .slot-actions button{
    pointer-events:auto;
    border-top:2px solid var(--w95-light);
    border-left:2px solid var(--w95-light);
    border-right:2px solid var(--w95-shadow);
    border-bottom:2px solid var(--w95-shadow);
    background: var(--w95-bg);
    padding:6px 8px;
    font-weight:900;
    cursor:pointer;
    font-size:12px;
    font-family: inherit;
    color:#000;
    touch-action: manipulation;
  }
  .photo-slot .slot-actions button:active{
    border-top:2px solid var(--w95-shadow);
    border-left:2px solid var(--w95-shadow);
    border-right:2px solid var(--w95-light);
    border-bottom:2px solid var(--w95-light);
  }

  .photos-toolbar{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin-bottom:8px;
  }
  .photos-hint{
    font-size:12px;
    font-weight:900;
    opacity:.85;
    line-height:1.25;
  }

  @media (max-width: 980px){
    :root{
      --page-padding: 14px;
      --logo-w: 150px;
      --logo-h: 110px;
      --photo-w: 140px;
      --photo-h: 180px;
    }
    .header-meta{ min-width: 150px; }
    .page{ box-shadow: inset 1px 1px 0 #fff, 0 3px 10px rgba(0,0,0,.14); }
  }

  @media (max-width: 720px){
    :root{
      --page-padding: 12px;
      --logo-w: 100%;
      --logo-h: 120px;
      --photo-w: 100%;
      --photo-h: 210px;
    }

    .topbar .row{
      padding:10px;
      gap:10px;
    }
    .group{
      width:100%;
      justify-content:stretch;
    }
    .group > button{
      flex:1 1 0;
      min-width: 0;
    }

    .cta{ font-size:16px; padding:16px 14px; }

    .doc-header{
      flex-direction:column;
      align-items:stretch;
      gap:10px;
    }
    .logo{
      width:100%;
      height:120px;
    }
    .header-meta{
      min-width:0;
      text-align:left;
    }

    .photos{
      grid-template-columns: 1fr;
    }
    .photo-slot{
      width:100%;
      height:var(--photo-h);
    }
  }

  @media (max-width: 420px){
    .btn, .topbar button{
      padding:12px 10px;
      font-size:12px;
    }
    .textline input[type="text"], textarea{
      font-size:16px;
    }
  }

  @media print{
    .topbar,.ctaWrap,.statusline{display:none !important;}
    .workspace{padding:0;}
    .page{
      width:210mm;
      min-height:297mm;
      margin:0;
      border:none;
      box-shadow:none;
      padding:10mm;
    }
    body{background:#fff;}
    :root{
      --logo-w: 190px;
      --logo-h: 140px;
      --photo-w: 160px;
      --photo-h: 200px;
      --page-padding: 10mm;
    }
    .photo-slot .slot-actions,
    .photos-toolbar{ display:none !important; }
  }
</style>

<!-- Firebase (compat, sin bundler) -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
</head>

<body>

<div class="topbar">
  <div class="row">
    <div class="group">
      <button id="btnExportPDF" class="btn" type="button" onclick="exportPDF()" disabled>Exportar PDF</button>
      <button id="btnSaveInspection" class="btn" type="button" onclick="saveCurrentInspection()" disabled>Guardar inspección</button>
      <button id="btnResetForm" class="btn" type="button" onclick="resetCurrentForm()" disabled>Reiniciar formulario</button>
    </div>
  </div>
</div>

<div class="ctaWrap">
  <button id="btnReadTag" class="cta" type="button" onclick="readTagAndOpen()">LEER TAG</button>
</div>

<div class="statusline" id="statusLine">
  <div><b>Estado:</b> Sin JSON importado.</div>
  <div><b>Formulario:</b> Ninguno.</div>
  <div><b>NFC:</b> Inicializando…</div>
</div>

<div class="workspace">
  <div id="capture" class="page">
    <div id="docHeader" class="doc-header">
      <div class="logo" id="logoBox"></div>
      <div class="header-text">
        <div id="docTitle" class="header-title">—</div>
        <div id="docSubtitle" class="header-subtitle">Importa JSON y pulsa “LEER TAG”</div>
      </div>
      <div class="header-meta">
        <div class="muted">Última edición</div>
        <div id="lastEdited">—</div>
      </div>
    </div>
    <div id="fieldsMount"></div>
  </div>
</div>

<script>
/* __GLOBAL_ERROR_WIRED__ */
let __shownGlobalErr = false;
function __showGlobalErr(prefix, err){
  try{
    console.error(prefix, err);
    if(__shownGlobalErr) return;
    __shownGlobalErr = true;
    alert(prefix + ': ' + ((err && (err.message||err.code)) ? (err.code? (err.code+': '):'') + err.message : String(err)));
  }catch(_){}
}
window.addEventListener('error', (e)=>__showGlobalErr('Error JS', e.error || e.message));
window.addEventListener('unhandledrejection', (e)=>__showGlobalErr('Promesa rechazada', e.reason));


/* __FS_HELPERS_GLOBAL__ */

  // ===== Helpers Firestore (errores) =====
  function fsErrShort(e){
    try{
      const code = e && (e.code || e.name) ? String(e.code || e.name) : '';
      const msg = e && e.message ? String(e.message) : String(e||'');
      const out = (code && msg) ? (code + ' — ' + msg) : (code || msg);
      return out.trim() || 'error';
    }catch(_){ return 'error'; }
  }
  function fsRulesHint(e){
    const s = (e && (e.code || '') ? String(e.code) : '') + ' ' + (e && e.message ? String(e.message) : '');
    if(/permission-denied/i.test(s)){
      return "\n\nPermisos Firestore: abre Rules temporalmente o añade Auth (sin login, por defecto bloquea).";
    }
    if(/failed-precondition/i.test(s) && /index/i.test(s)){
      return "\n\nFalta un índice compuesto (Firestore -> Indexes).";
    }
    if(/unavailable|network|offline|fetch/i.test(s)){
      return "\n\nProblema de red/bloqueo del navegador.";
    }
    return "";
  }


  /* ===== Firebase (Cloud Firestore) ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyBLP0yGc_Yh0nKGNYbPcYabTg25LDw2wco",
    authDomain: "inspector-b4f41.firebaseapp.com",
    projectId: "inspector-b4f41",
    storageBucket: "inspector-b4f41.firebasestorage.app",
    messagingSenderId: "333394046622",
    appId: "1:333394046622:web:caa18c6f1d341b0a97158f"
  };

  const TPL_COLLECTION = 'templates_v1';
  const INS_COLLECTION = 'inspections_v1';

  let __firebaseApp = null;
  let __fs = null;

  function initFirebase(){
    try{
      if(!window.firebase) return false;
      if(!firebase.apps || !firebase.apps.length){
        __firebaseApp = firebase.initializeApp(firebaseConfig);
      }else{
        __firebaseApp = firebase.app();
      }

  function fsErrShort(e){
    try{
      const code = e && (e.code || e.name) ? String(e.code || e.name) : '';
      const msg = e && e.message ? String(e.message) : String(e||'');
      const out = (code && msg) ? (code + ' — ' + msg) : (code || msg);
      return out.trim() || 'error';
    }catch(_){ return 'error'; }
  }
  function fsRulesHint(e){
    const s = (e && (e.code || '') ? String(e.code) : '') + ' ' + (e && e.message ? String(e.message) : '');
    if(/permission-denied/i.test(s)){
      return "\n\nParece un problema de REGLAS: si no usas login, Firestore debe permitir lecturas/escrituras públicas (o habilitar Auth).";
    }
    if(/failed-precondition/i.test(s) && /index/i.test(s)){
      return "\n\nParece faltar un índice compuesto en Firestore (consola -> Firestore -> Indexes).";
    }
    if(/unavailable|network|offline|fetch/i.test(s)){
      return "\n\nParece un problema de conexión/red o bloqueo del navegador.";
    }
    return "";
  }

      __fs = firebase.firestore();
      return true;
    }catch(e){
      console.error(e);
      __fs = null;
      return false;
    }
  }
  function cloudReady(){ return !!__fs; }

  async function cloudFetchAllTemplates(){
    if(!cloudReady()) return [];
    const snap = await __fs.collection(TPL_COLLECTION).get();
    const arr = [];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      const data = (d.data && typeof d.data === 'object') ? d.data : null;
      if(!data) return;
      arr.push({
        id: doc.id,
        name: String(d.name || ''),
        category: String(d.category || ''),
        code: String(d.code || ''),
        createdAt: d.createdAt ? String(d.createdAt) : '',
        updatedAt: d.updatedAt ? String(d.updatedAt) : '',
        data
      });
    });
    return arr.filter(t=>t.id && t.name && t.category && t.data);
  }

  async function cloudFindTemplateByCode(code){
    if(!cloudReady()) return null;
    const c = normalize(code);
    if(!c) return null;
    const qs = await __fs.collection(TPL_COLLECTION).where('code','==',c).limit(1).get();
    if(qs.empty) return null;
    const doc = qs.docs[0];
    const d = doc.data() || {};
    const data = (d.data && typeof d.data === 'object') ? d.data : null;
    if(!data) return null;
    return {
      id: doc.id,
      name: String(d.name || ''),
      category: String(d.category || ''),
      code: String(d.code || ''),
      createdAt: d.createdAt ? String(d.createdAt) : '',
      updatedAt: d.updatedAt ? String(d.updatedAt) : '',
      data
    };
  }

  async function cloudSaveInspectionDoc(payload){
    if(!cloudReady()) throw new Error('Firestore no está inicializado.');
    const id = String(payload.id || makeId());
    await __fs.collection(INS_COLLECTION).doc(id).set(payload, { merge:true });
    return id;
  }

  async function cloudFetchAllInspections(){
    if(!cloudReady()) return [];
    const snap = await __fs.collection(INS_COLLECTION).get();
    const arr = [];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      arr.push({ id: doc.id, ...d });
    });
    return arr;
  }


  const FIXED_LOGO_URL = 'https://i.ibb.co/BK6jvxPG/image.png';

  const PHOTO_MAX_EDGE = 1600;
  const PHOTO_JPEG_QUALITY = 0.82;
  const PHOTO_SLOTS_DEFAULT = 4;

  const db = [];
  let currentId = null;
  let lastEditedISO = null;

  let nfcReader = null;
  let nfcActive = false;
  let nfcEverStarted = false;
  let lastNFCTag = '';
  let lastNFCTimeISO = null;
  let nfcStatusText = 'Inicializando…';
  let pendingOpenFromNFC = false;

  let lastOpenedTag = '';

  const STORAGE_KEY = null;
  const INSPECTIONS_KEY = null;

  const inspections = [];

  async function loadInspections(){
    inspections.length = 0;
    if(!cloudReady()) return false;
    try{
      const rows = await cloudFetchAllInspections();
      rows.sort((a,b)=> String(b.updatedAt||b.savedAtISO||'').localeCompare(String(a.updatedAt||a.savedAtISO||'')));
      for(const d of rows){
        // Soportar inspecciones guardadas como {name,category,code,data:ins}
        const ins = (d && d.data && typeof d.data === 'object') ? d.data : d;
        if(!ins || typeof ins !== 'object') continue;
        if(!ins.id || !ins.data) continue;
        inspections.push(ins);
      }
      return true;
    }catch(e){
      console.error(e);
      return false;
    }
  }

  function saveInspections(){
    // Persistir inspecciones en Firestore (fuente de verdad)
    if(!cloudReady()) return;
    // Sincroniza solo las nuevas inspecciones añadidas desde la última sync
    if(typeof window.__insLastSyncedIndex !== 'number') window.__insLastSyncedIndex = 0;
    if(window.__insSyncInFlight) return;
    const start = Math.max(0, window.__insLastSyncedIndex|0);
    const pending = inspections.slice(start);
    if(!pending.length) return;

    window.__insSyncInFlight = true;
    (async ()=>{
      // chunk defensivo (batch limit 500)
      let i = 0;
      while(i < pending.length){
        const chunk = pending.slice(i, i+400);
        const batch = __fs.batch();
        for(const ins of chunk){
          if(!ins || typeof ins !== 'object' || !ins.id) continue;
          const payload = {
            ...ins,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          };
          const ref = __fs.collection(INS_COLLECTION).doc(String(ins.id));
          batch.set(ref, payload, { merge:true });
        }
        await batch.commit();
        i += chunk.length;
      }
      window.__insLastSyncedIndex = inspections.length;
    })().catch(e=>{
      console.error(e);
      alert('No se pudo guardar en Firestore. ' + fsErrShort(e) + (fsRulesHint(e) ? ('\n' + fsRulesHint(e)) : ''));
    }).finally(()=>{
      window.__insSyncInFlight = false;
    });
  }

  function safeLSSet(key, value){ return false; }
  function safeLSGet(key){ return null; }
  function safeLSRemove(key){ return false; }

  function serializeState(){
    return {
      v: 1,
      savedAt: nowISO(),
      db,
      currentId,
      lastEditedISO,
      lastNFCTag,
      lastNFCTimeISO,
      lastOpenedTag
    };
  }

  function validateTemplate(t){
    if(!t || typeof t !== 'object') return false;
    if(!t.id || !t.category || !t.form) return false;
    if(!t.baseData || typeof t.baseData !== 'object') return false;
    if(!t.data || typeof t.data !== 'object') return false;
    if(!Array.isArray(t.tags)) t.tags = [];
    return true;
  }


  async function loadTemplatesFromCloud(){
    if(!cloudReady()) return false;
    try{
      const templates = await cloudFetchAllTemplates();
      db.length = 0;
      for(const t of templates){
        const layout = (t.data && typeof t.data === 'object') ? deepClone(t.data) : null;
        if(!layout) continue;
        layout.header = (layout.header && typeof layout.header==='object') ? layout.header : {};
        layout.theme = (layout.theme && typeof layout.theme==='object') ? layout.theme : {};
        layout.fields = Array.isArray(layout.fields) ? layout.fields : [];
        layout.header.logo = FIXED_LOGO_URL;

        // Normaliza campos de fotos para evitar nulls
        for(const f of layout.fields){
          if(f && normalize(f.type)==='photos'){
            f.config = (f.config && typeof f.config==='object') ? f.config : {};
            const slots = getPhotoSlotsForField(f);
            f.images = Array.isArray(f.images) ? f.images : [];
            f.images = f.images.slice(0, slots);
            while(f.images.length < slots) f.images.push(null);
          }
        }

        const tags = [];
        const code = normalize(t.code || '');
        if(code) tags.push(code);

        db.push({
          id: String(t.id),
          category: normalize(t.category),
          form: normalize(t.name),
          tags,
          baseData: deepClone(layout),
          data: deepClone(layout)
        });
      }
      return true;
    }catch(e){
      console.error(e);
      return false;
    }
  }


  function loadState(){
    // Fuente de verdad: Firestore. No persistimos en local.
    return false;
  }

  function saveState(){
    // no-op (sin localStorage)
  }

  function serializeInspection(item){
    refreshAutoGrow();
    touchEdited();
    const lastISO = normalize(lastEditedISO) || nowISO();
    const data = deepClone(item.data || {});
    data.header = (data.header && typeof data.header === 'object') ? data.header : {};
    data.header.logo = FIXED_LOGO_URL;
    data.header.lastEdited = lastISO;

    data.meta = (data.meta && typeof data.meta === 'object') ? data.meta : {};
    data.meta.category = data.meta.category || item.category || '';
    data.meta.name = data.meta.name || item.form || '';

    return {
      id: makeId(),                     // SIEMPRE NUEVO ID -> inspección distinta
      savedAtISO: nowISO(),
      templateId: item.id || '',
      tag: normalize(lastOpenedTag) || normalize(lastNFCTag) || '',
      category: item.category || data.meta.category || '',
      form: item.form || data.meta.name || '',
      lastEditedISO: lastISO,
      data
    };
  }

  

  function escapeHTML(str){
    return String(str ?? '').replace(/[&<>"']/g, m=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function escapeAttr(str){
    return escapeHTML(str).replace(/"/g,'&quot;');
  }
  function safeJSONParse(txt){
    try{ return JSON.parse(txt); }catch(e){ return null; }
  }
  function normalize(s){ return String(s ?? '').trim(); }
  function nowISO(){ return new Date().toISOString(); }
  function fmtLastEdited(iso){
    if(!iso) return '—';
    try{ return new Date(iso).toLocaleString('es-ES'); }catch(e){ return String(iso); }
  }
  function updateLastEditedUI(){
    document.getElementById('lastEdited').textContent = fmtLastEdited(lastEditedISO);
  }
  function makeId(){
    if(window.crypto && typeof window.crypto.randomUUID === 'function') return window.crypto.randomUUID();
    return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }
  function deepClone(obj){
    try{ return structuredClone(obj); }catch(e){ return JSON.parse(JSON.stringify(obj)); }
  }
  function applyFixedLogo(){
    const logoBox = document.getElementById('logoBox');
    if(!logoBox) return;
    logoBox.innerHTML = '';
    const img = document.createElement('img');
    img.src = FIXED_LOGO_URL;
    img.alt = 'Logo';
    logoBox.appendChild(img);
    logoBox.dataset.logo = FIXED_LOGO_URL;
  }
  function autoGrow(t){
    t.style.height = 'auto';
    t.style.height = (t.scrollHeight + 2) + 'px';
  }
  function refreshAutoGrow(){
    document.querySelectorAll('textarea.autogrow').forEach(autoGrow);
  }
  document.addEventListener('input', (e)=>{
    if(e.target && e.target.matches('textarea.autogrow')) autoGrow(e.target);
  });

  function setVar(name, value){
    if(!value) return;
    document.documentElement.style.setProperty(name, value);
  }

  function getCurrentItem(){
    if(!currentId) return null;
    return db.find(x=>x.id===currentId) || null;
  }

  function exportStamp(date){
    const d = date instanceof Date ? date : new Date();
    const pad = (n)=> String(n).padStart(2,'0');
    const y = d.getFullYear();
    const m = pad(d.getMonth()+1);
    const da = pad(d.getDate());
    const h = pad(d.getHours());
    const mi = pad(d.getMinutes());
    const se = pad(d.getSeconds());
    return `${y}-${m}-${da}_${h}-${mi}-${se}`;
  }

  function makeSafeName(name, fallback){
    const out = normalize(name)
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-zA-Z0-9_\-]+/g,'_')
      .replace(/_+/g,'_')
      .replace(/^_+|_+$/g,'');
    return out || fallback || 'Archivo';
  }

  function saveBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename || 'export.json';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{
      URL.revokeObjectURL(url);
      a.remove();
    }, 2500);
  }

  function updateReadTagButtonText(){
    const btn = document.getElementById('btnReadTag');
    if(!btn) return;

    const hasDB = db.length > 0;
    if(!hasDB){
      btn.textContent = 'LEER TAG';
      return;
    }

    const q = normalize(lastNFCTag);
    const opened = normalize(lastOpenedTag);

    if(q && (!opened || q.toLowerCase() !== opened.toLowerCase())){
      btn.textContent = 'ABRIR FORMULARIO';
    }else{
      btn.textContent = 'LEER TAG';
    }
  }

  function updateButtons(){
    const hasDB = db.length > 0;
    const hasCurrent = !!getCurrentItem();
    const hasInspections = inspections.length > 0;
    const btnRead = document.getElementById('btnReadTag');

    if(btnRead) btnRead.disabled = !hasDB;

    const elPDF = document.getElementById('btnExportPDF');
    if(elPDF) elPDF.disabled = !hasCurrent;

    const elJSON = document.getElementById('btnExportJSON');
    if(elJSON) elJSON.disabled = !hasInspections;

    const elReset = document.getElementById('btnResetForm');
    if(elReset) elReset.disabled = !hasCurrent;

    const elSave = document.getElementById('btnSaveInspection');
    if(elSave) elSave.disabled = !hasCurrent;

    updateReadTagButtonText();
  }

  function updateStatus(){
    const el = document.getElementById('statusLine');
    const count = db.length;
    const insCount = inspections.length;
    const item = getCurrentItem();

    const a = (count === 0)
      ? 'Sin JSON importado.'
      : `Plantillas cargadas: ${count}`;

    const ins = `Inspecciones guardadas: ${insCount}`;

    const b = item
      ? `${escapeHTML(item.category)} / ${escapeHTML(item.form)}`
      : 'Ninguno.';

    el.innerHTML = `<div><b>Estado:</b> ${a}</div><div><b>Inspecciones:</b> ${ins}</div><div><b>Formulario:</b> ${b}</div><div><b>NFC:</b> ${escapeHTML(nfcStatusText || '—')}</div>`;
    updateButtons();
  }

  function exportPDF(){
    const item = getCurrentItem();
    if(!item){
      alert('No hay formulario abierto.');
      return;
    }

    const oldTitle = document.title;
    document.title = `${item.category} - ${item.form}`;

    refreshAutoGrow();
    window.print();

    document.title = oldTitle;
  }

  
  // ===== Modo nube: botones legacy (sin export/import local) =====
  function exportCloudInfoBBDD(){
    alert('Modo nube: la Base de datos lee directamente desde Firestore.\n\nNo hace falta exportar/importar JSON.');
  }


// ✅ MODIFICADO: al guardar, se guarda y se reinicia el formulario automáticamente.
  // Guardar el mismo formulario varias veces => varias inspecciones distintas (id nuevo cada vez).
  async function saveCurrentInspection(){
    const item = getCurrentItem();
    if(!item || !item.data){
      alert('No hay formulario abierto.');
      return;
    }

    const ins = serializeInspection(item);

    // Persistir en Firestore (fuente de verdad)
    if(cloudReady()){
      try{
        const payload = {
  // duplicados para búsquedas rápidas en Firestore
  category: String(ins.category || ''),
  code: String(ins.tag || ''),
  tag: String(ins.tag || ''),
  createdAt: String(ins.savedAtISO || nowISO()),
  updatedAt: String(ins.lastEditedISO || ins.savedAtISO || nowISO()),
  // el documento guarda la inspección con la MISMA forma que antes
  ...ins
};
        await cloudSaveInspectionDoc({ id: ins.id, ...payload });
      }catch(e){
        console.error(e);
        alert('No se pudo guardar en Firestore.\n' + fsErrShort(e) + fsRulesHint(e));
        return;
      }
    }else{
      alert('Firestore no está disponible. No se guardará la inspección.');
      return;
    }

    // Mantener cache en memoria (para exportar JSON si quieres)
    inspections.push(ins);
    
    // Reinicio inmediato del formulario (sin confirmación)
    resetCurrentForm({ silent: true });

    updateStatus();
    alert('Inspección guardada. Formulario reiniciado.');
  }

  function exportAllInspectionsForDB(){
    if(inspections.length === 0){
      alert('No hay inspecciones guardadas.');
      return;
    }

    const out = {
      format: 'inspector_inspections_v1',
      exportedAtISO: nowISO(),
      inspections: inspections.map(x=>deepClone(x)) // ✅ 100% de todas las inspecciones guardadas
    };

    const filename = `inspecciones__${exportStamp(new Date())}.json`;

    try{
      const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json;charset=utf-8' });
      saveBlob(blob, filename);
    }catch(e){
      alert('No se pudo exportar el JSON.');
    }
  }

  function readFileAsDataURL(file){
    return new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = ()=> resolve(String(fr.result || ''));
      fr.onerror = ()=> reject(new Error('No se pudo leer el archivo.'));
      fr.readAsDataURL(file);
    });
  }

  function loadImageFromDataURL(dataUrl){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = ()=> resolve(img);
      img.onerror = ()=> reject(new Error('No se pudo cargar la imagen.'));
      img.src = dataUrl;
    });
  }

  async function fileToCompressedDataURL(file){
    const rawDataUrl = await readFileAsDataURL(file);

    try{
      const img = await loadImageFromDataURL(rawDataUrl);

      const w = img.naturalWidth || img.width || 0;
      const h = img.naturalHeight || img.height || 0;
      if(!w || !h) return rawDataUrl;

      const maxEdge = PHOTO_MAX_EDGE;
      const scale = Math.min(1, maxEdge / Math.max(w, h));
      const tw = Math.max(1, Math.round(w * scale));
      const th = Math.max(1, Math.round(h * scale));

      if(scale === 1){
        return rawDataUrl;
      }

      const canvas = document.createElement('canvas');
      canvas.width = tw;
      canvas.height = th;
      const ctx = canvas.getContext('2d', { alpha: false });
      if(!ctx) return rawDataUrl;

      ctx.drawImage(img, 0, 0, tw, th);

      const out = canvas.toDataURL('image/jpeg', PHOTO_JPEG_QUALITY);
      return out || rawDataUrl;
    }catch(e){
      return rawDataUrl;
    }
  }

  function clampInt(n, min, max){
    const x = parseInt(String(n), 10);
    if(!Number.isFinite(x)) return min;
    return Math.max(min, Math.min(max, x));
  }

  function getPhotoSlotsForField(fieldObj){
    const cfg = (fieldObj && fieldObj.config && typeof fieldObj.config==='object') ? fieldObj.config : {};
    const slots = clampInt(cfg.slots ?? PHOTO_SLOTS_DEFAULT, 1, 12);
    return slots;
  }

  function openPhotoPicker({ multiple=false } = {}){
    return new Promise((resolve)=>{
      const inp = document.createElement('input');
      inp.type = 'file';
      inp.accept = 'image/*';
      inp.setAttribute('capture', 'environment');
      inp.multiple = !!multiple;
      inp.onchange = ()=> {
        const files = [...(inp.files || [])].filter(f => f && f.type && f.type.startsWith('image/'));
        resolve(files);
      };
      inp.click();
    });
  }

  function touchEdited(){
    lastEditedISO = nowISO();
    updateLastEditedUI();

    const item = getCurrentItem();
    if(item && item.data){
      item.data.header = item.data.header || {};
      item.data.header.lastEdited = lastEditedISO;
    }

    saveState();
  }

  async function addPhotosToField(idx, { replaceAt = null } = {}){
    const item = getCurrentItem();
    if(!item || !item.data) return;

    const fields = Array.isArray(item.data.fields) ? item.data.fields : [];
    const f = fields[idx];
    if(!f) return;

    f.images = Array.isArray(f.images) ? f.images : [];
    f.config = (f.config && typeof f.config==='object') ? f.config : {};

    const slots = getPhotoSlotsForField(f);

    const files = await openPhotoPicker({ multiple: replaceAt === null });
    if(!files || files.length === 0) return;

    try{
      if(replaceAt !== null){
        const pos = clampInt(replaceAt, 0, slots - 1);
        const dataUrl = await fileToCompressedDataURL(files[0]);
        f.images[pos] = dataUrl;
      }else{
        for(const file of files){
          if(f.images.filter(Boolean).length >= slots) break;
          const dataUrl = await fileToCompressedDataURL(file);

          let putAt = f.images.findIndex(x => !x);
          if(putAt === -1) putAt = f.images.length;

          if(putAt >= slots) break;

          f.images[putAt] = dataUrl;
        }
      }

      f.images = f.images.slice(0, slots);
      while(f.images.length < slots) f.images.push('');

      touchEdited();
      loadLayoutFromData(item.data);
    }catch(err){
      alert('No se pudo procesar la imagen.');
    }
  }

  function removePhotoFromField(idx, pos){
    const item = getCurrentItem();
    if(!item || !item.data) return;

    const fields = Array.isArray(item.data.fields) ? item.data.fields : [];
    const f = fields[idx];
    if(!f) return;

    f.images = Array.isArray(f.images) ? f.images : [];
    const slots = getPhotoSlotsForField(f);

    const p = clampInt(pos, 0, slots - 1);
    if(p >= 0 && p < f.images.length){
      f.images[p] = '';
      f.images = f.images.slice(0, slots);
      while(f.images.length < slots) f.images.push('');
      touchEdited();
      loadLayoutFromData(item.data);
    }
  }

  function renderEmptyDocument(){
    lastEditedISO = nowISO();
    updateLastEditedUI();
    applyFixedLogo();

    document.getElementById('docTitle').textContent = '—';
    document.getElementById('docSubtitle').textContent = 'Importa JSON y pulsa “LEER TAG”';

    document.getElementById('fieldsMount').innerHTML = '';
    updateStatus();
  }

  function fieldHTML(d, idx){
    const type = normalize(d.type) || 'text';
    const title = (d.title ?? '').toString();
    const config = (d.config && typeof d.config==='object') ? d.config : {};

    if(type === 'text'){
      const v = (d.value ?? '').toString();
      return `
        <div class="field" data-type="text" data-idx="${idx}">
          <div class="field-head">
            <div class="title">${escapeHTML(title)}</div>
          </div>
          <div class="field-body textline">
            <input type="text" value="${escapeAttr(v)}" oninput="onFieldChange(${idx})">
          </div>
        </div>
      `;
    }

    if(type === 'radio'){
      const options = Array.isArray(config.options) && config.options.length ? config.options : ["Bien","Mal","No dispone"];
      const selected = (d.selected ?? '').toString();
      const obs = (d.obs ?? '').toString();
      const name = `r_${idx}`;
      return `
        <div class="field" data-type="radio" data-idx="${idx}">
          <div class="field-head">
            <div class="title">${escapeHTML(title)}</div>
          </div>
          <div class="field-body">
            <div class="opts">
              ${options.map(o=>{
                const ck = (selected === o) ? 'checked' : '';
                return `<label><input type="radio" name="${name}" value="${escapeAttr(o)}" ${ck} onchange="onFieldChange(${idx})"> ${escapeHTML(o)}</label>`;
              }).join('')}
            </div>
            <textarea class="autogrow" placeholder="Observaciones" oninput="onFieldChange(${idx})">${escapeHTML(obs)}</textarea>
          </div>
        </div>
      `;
    }

    if(type === 'photos'){
      const imagesRaw = Array.isArray(d.images) ? d.images : [];
      const slots = clampInt(config.slots ?? PHOTO_SLOTS_DEFAULT, 1, 12);

      const images = imagesRaw.slice(0, slots);
      while(images.length < slots) images.push('');

      const hint = config.hint ? String(config.hint) : 'Pulsa “Añadir foto(s)” o “Cambiar” en una ranura para cargar una fotografía desde el dispositivo.';

      return `
        <div class="field" data-type="photos" data-idx="${idx}">
          <div class="field-head">
            <div class="title">${escapeHTML(title)}</div>
          </div>
          <div class="field-body">
            <div class="photos-toolbar">
              <button class="btn" type="button" onclick="addPhotosToField(${idx})">Añadir foto(s)</button>
              <div class="photos-hint">${escapeHTML(hint)}</div>
            </div>

            <div class="photos" id="grid_${idx}">
              ${images.map((src, pos)=>{
                const has = !!normalize(src);
                if(has){
                  return `
                    <div class="photo-slot">
                      <img src="${escapeAttr(src)}" alt="Foto ${pos+1}">
                      <div class="slot-actions">
                        <button type="button" onclick="addPhotosToField(${idx}, { replaceAt: ${pos} })">Cambiar</button>
                        <button type="button" onclick="removePhotoFromField(${idx}, ${pos})">Borrar</button>
                      </div>
                    </div>
                  `;
                }
                return `
                  <div class="photo-slot">
                    <div class="ph">Sin foto<br>(ranura ${pos+1}/${slots})</div>
                    <div class="slot-actions">
                      <button type="button" onclick="addPhotosToField(${idx}, { replaceAt: ${pos} })">Añadir</button>
                      <button type="button" onclick="removePhotoFromField(${idx}, ${pos})" disabled>Borrar</button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;
    }

    return `
      <div class="field" data-type="${escapeAttr(type)}" data-idx="${idx}">
        <div class="field-head"><div class="title">${escapeHTML(title)}</div></div>
        <div class="field-body">
          <div style="font-size:12px;font-weight:900">Tipo no soportado: ${escapeHTML(type)}</div>
        </div>
      </div>
    `;
  }

  function loadLayoutFromData(data){
    if(!data || typeof data !== 'object'){
      alert('Datos inválidos.');
      return;
    }

    if(data.theme){
      setVar('--border', data.theme.border || '#000000');
      setVar('--header-bg', data.theme.headerBg || '#ffffff');
      setVar('--header-text', data.theme.headerText || '#000000');
      setVar('--section-bg', data.theme.sectionBg || '#e6e6e6');
      setVar('--section-text', data.theme.sectionText || '#000000');
      setVar('--page-bg', data.theme.pageBg || '#ffffff');
    }

    const h = data.header && typeof data.header==='object' ? data.header : {};
    const title = h.title || '';
    const subtitle = h.subtitle || '';

    lastEditedISO = h.lastEdited || nowISO();
    updateLastEditedUI();
    applyFixedLogo();

    document.getElementById('docTitle').textContent = title;
    document.getElementById('docSubtitle').textContent = subtitle;

    const mount = document.getElementById('fieldsMount');
    const fields = Array.isArray(data.fields) ? data.fields : [];

    for(const f of fields){
      if(f && normalize(f.type) === 'photos'){
        f.config = (f.config && typeof f.config==='object') ? f.config : {};
        const slots = getPhotoSlotsForField(f);
        f.images = Array.isArray(f.images) ? f.images : [];
        f.images = f.images.slice(0, slots);
        while(f.images.length < slots) f.images.push('');
      }
    }

    mount.innerHTML = fields.map((d,i)=>fieldHTML(d,i)).join('');

    refreshAutoGrow();
    updateStatus();
  }

  function onFieldChange(idx){
    const item = getCurrentItem();
    if(!item || !item.data) return;

    const fields = Array.isArray(item.data.fields) ? item.data.fields : [];
    const f = fields[idx];
    if(!f) return;

    const fieldEl = document.querySelector(`.field[data-idx="${idx}"]`);
    if(!fieldEl) return;

    const type = fieldEl.getAttribute('data-type');

    if(type === 'text'){
      const v = fieldEl.querySelector('input[type="text"]')?.value ?? '';
      f.value = v;
      touchEdited();
    }

    if(type === 'radio'){
      const checked = fieldEl.querySelector('input[type="radio"]:checked');
      f.selected = checked ? (checked.value || checked.parentElement.textContent.trim()) : '';
      const obs = fieldEl.querySelector('textarea')?.value ?? '';
      f.obs = obs;
      f.config = (f.config && typeof f.config==='object') ? f.config : {};
      touchEdited();
    }
  }

  // ✅ MODIFICADO: permite reset silencioso (para usar tras guardar)
  function resetCurrentForm(opts = {}){
    const item = getCurrentItem();
    if(!item){
      alert('No hay formulario abierto.');
      return;
    }

    const silent = !!opts.silent;
    if(!silent){
      const ok = confirm('¿Reiniciar el formulario? Se perderán los cambios no guardados en esta sesión.');
      if(!ok) return;
    }

    item.data = deepClone(item.baseData);
    if(item.data && item.data.header) item.data.header.logo = FIXED_LOGO_URL;

    lastEditedISO = nowISO();
    if(item.data){
      item.data.header = item.data.header || {};
      item.data.header.lastEdited = lastEditedISO;
    }
    loadLayoutFromData(item.data);
    saveState();
  }

  function isNFCSupported(){
    return ('NDEFReader' in window);
  }

  async function startNFC(auto = false){
    if(!isNFCSupported()){
      nfcStatusText = 'No soportado en este navegador';
      updateStatus();
      return false;
    }
    if(nfcActive) return true;

    try{
      nfcReader = new NDEFReader();
      await nfcReader.scan();

      nfcActive = true;
      nfcEverStarted = true;
      nfcStatusText = 'Escuchando… acerca un TAG';
      updateStatus();

      nfcReader.onreading = (event)=>{
        const uid = event && event.serialNumber ? String(event.serialNumber) : '';
        if(uid){
          lastNFCTag = uid;
          lastNFCTimeISO = nowISO();
          nfcStatusText = `TAG leído: ${uid}`;
        }else{
          nfcStatusText = 'TAG leído (sin UID)';
        }
        saveState();
        updateStatus();
        if(pendingOpenFromNFC && uid){
          pendingOpenFromNFC = false;
          openByTag(uid);
        }
      };

      nfcReader.onreadingerror = ()=>{
        nfcStatusText = 'Error al leer TAG';
        updateStatus();
      };

      return true;
    }catch(err){
      const name = err && err.name ? String(err.name) : '';
      if(auto){
        nfcStatusText = (name === 'NotAllowedError' || name === 'SecurityError')
          ? 'Pulsa “LEER TAG” para activar NFC'
          : 'No se pudo activar NFC';
      }else{
        nfcStatusText = (name === 'NotAllowedError' || name === 'SecurityError')
          ? 'Permiso NFC denegado / requiere gesto'
          : 'No se pudo activar NFC';
      }
      updateStatus();
      return false;
    }
  }

  function findTemplatesByTag(tag){
    const t = normalize(tag);
    if(!t) return [];
    return db.filter(x =>
      Array.isArray(x.tags) && x.tags.some(z => normalize(z).toLowerCase() === t.toLowerCase())
    );
  }

  function openTemplate(item){
    if(!item || !item.data){
      alert('Plantilla inválida.');
      return;
    }
    currentId = item.id;
    loadLayoutFromData(item.data);
    saveState();
  }

  async function openByTag(tag){
    const q = normalize(tag);
    if(!q) return;

    const openedTag = normalize(lastOpenedTag);
    if(q && openedTag && q.toLowerCase() === openedTag.toLowerCase()){
      return;
    }

    const matches = findTemplatesByTag(q);
    if(matches.length === 0){
      // Fallback: buscar en Firestore por código (TAG)
      if(cloudReady()){
        try{
          const t = await cloudFindTemplateByCode(q);
          if(t && t.data){
            // añadir a memoria y reintentar
            const layout = deepClone(t.data);
            layout.header = (layout.header && typeof layout.header==='object') ? layout.header : {};
            layout.theme = (layout.theme && typeof layout.theme==='object') ? layout.theme : {};
            layout.fields = Array.isArray(layout.fields) ? layout.fields : [];
            layout.header.logo = FIXED_LOGO_URL;

            const tags = [];
            const code = normalize(t.code || '');
            if(code) tags.push(code);

            const item = {
              id: String(t.id),
              category: normalize(t.category),
              form: normalize(t.name),
              tags,
              baseData: deepClone(layout),
              data: deepClone(layout)
            };
            db.push(item);
            openTemplate(item);
            lastOpenedTag = q;
            saveState();
            updateReadTagButtonText();
            updateButtons();
            updateStatus();
            return;
          }
        }catch(e){
          console.error(e);
        }
      }

      alert(`No se encontró ninguna plantilla con el TAG: ${q}`);
      return;
    }

    if(matches.length === 1){
      openTemplate(matches[0]);
      lastOpenedTag = q;
      saveState();
      updateReadTagButtonText();
      return;
    }

    const list = matches
      .map((m, i)=> `${i+1}) ${m.category} / ${m.form} (archivo: ${m.sourceFileName || '—'})`)
      .join('\n');

    const pick = prompt(
      `Hay ${matches.length} formularios con el TAG "${q}".\n\nElige número:\n${list}\n\nEscribe 1-${matches.length}:`
    );
    if(pick === null) return;

    const n = parseInt(String(pick).trim(), 10);
    if(!Number.isFinite(n) || n < 1 || n > matches.length){
      alert('Selección inválida.');
      return;
    }

    openTemplate(matches[n-1]);
    lastOpenedTag = q;
    saveState();
    updateReadTagButtonText();
  }

  async function readTagAndOpen(){
    if(db.length === 0){
      alert('No hay plantillas en memoria. Se cargarán desde Firestore si es posible.');
      // intento rápido de carga
      await loadTemplatesFromCloud();
      if(db.length===0) return;
      return;
    }

    let q = normalize(lastNFCTag);

    const openedTag = normalize(lastOpenedTag);
    if(q && openedTag && q.toLowerCase() === openedTag.toLowerCase()){
      alert('Ya está abierto el formulario de este TAG. Acerca un TAG distinto y vuelve a pulsar “LEER TAG”.');
      updateReadTagButtonText();
      return;
    }

    if(!q){
      pendingOpenFromNFC = true;
      if(!nfcActive){
        startNFC(false);
      }
      if(isNFCSupported()){
        nfcStatusText = 'Acerca un TAG NFC…';
        updateStatus();
        return;
      }
    }

    if(!q){
      const tag = prompt('Introduce/pega el TAG leído:');
      if(tag === null) return;
      q = normalize(tag);
      if(!q){
        alert('TAG vacío.');
        return;
      }
    }

    await openByTag(q);
  }

  function importJsonFiles(){
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'application/json';
    inp.multiple = true;

    function normalizeTags(tagsRaw){
      if(Array.isArray(tagsRaw)){
        return tagsRaw.map(x=>normalize(x)).filter(Boolean);
      }
      if(typeof tagsRaw === 'string'){
        return tagsRaw.split(',').map(x=>normalize(x)).filter(Boolean);
      }
      return [];
    }

    function isFormuExportV2(obj){
      return !!(obj && typeof obj === 'object' && obj.format === 'formu_export_v2' && (obj.layout || obj.templates));
    }

    function extractLayout(raw){
      if(!raw || typeof raw !== 'object') return null;
      if(raw.header && Array.isArray(raw.fields)) return raw;
      if(raw.data && typeof raw.data === 'object' && raw.data.header && Array.isArray(raw.data.fields)) return raw.data;
      if(raw.layout && typeof raw.layout === 'object' && raw.layout.header && Array.isArray(raw.layout.fields)) return raw.layout;
      return raw;
    }

    function normalizeImportedTemplate(raw, fallbackCategory='', fallbackForm=''){
      if(!raw || typeof raw !== 'object') return null;

      const layout = extractLayout(raw);
      if(!layout || typeof layout !== 'object') return null;

      layout.header = (layout.header && typeof layout.header==='object') ? layout.header : {};
      layout.theme = (layout.theme && typeof layout.theme==='object') ? layout.theme : {};
      layout.fields = Array.isArray(layout.fields) ? layout.fields : [];

      const rawMeta = (raw.meta && typeof raw.meta === 'object') ? raw.meta : {};
      const layoutMeta = (layout.meta && typeof layout.meta === 'object') ? layout.meta : {};

      const category = normalize(raw.category || rawMeta.category || layoutMeta.category || fallbackCategory || '');
      const form = normalize(raw.name || raw.form || rawMeta.name || rawMeta.form || layoutMeta.name || layoutMeta.form || fallbackForm || '');

      if(!category || !form) return null;

      const tagsRaw = (rawMeta.tags ?? rawMeta.tag ?? raw.tags ?? raw.tag ?? layoutMeta.tags ?? layoutMeta.tag ?? []);
      let tags = normalizeTags(tagsRaw);

      const code = normalize(raw.code || rawMeta.code || layoutMeta.code || '');
      if(code && !tags.some(t=>normalize(t).toLowerCase()===code.toLowerCase())) tags.unshift(code);

      layout.header.logo = FIXED_LOGO_URL;

      for(const f of layout.fields){
        if(f && normalize(f.type)==='photos'){
          f.config = (f.config && typeof f.config==='object') ? f.config : {};
          const slots = getPhotoSlotsForField(f);
          f.images = Array.isArray(f.images) ? f.images : [];
          f.images = f.images.slice(0, slots);
          while(f.images.length < slots) f.images.push('');
        }
      }

      layout.meta = Object.assign({}, layoutMeta, rawMeta, {
        category,
        name: form,
        tags
      });
      if(code) layout.meta.code = code;

      return { category, form, tags, data: layout };
    }

    inp.onchange = async ()=>{
      const files = [...(inp.files || [])];
      if(files.length === 0) return;

      for(const file of files){
        const text = await file.text();
        const parsed = safeJSONParse(text);

        if(!parsed || typeof parsed !== 'object'){
          alert(`JSON inválido: ${file.name}`);
          continue;
        }

        let rawTemplates = [];

        if(isFormuExportV2(parsed)){
          if(Array.isArray(parsed.templates) && parsed.templates.length){
            rawTemplates = parsed.templates.slice();
          }else if(parsed.layout && typeof parsed.layout === 'object'){
            rawTemplates = [{
              category: '(Importado)',
              name: '(layout)',
              code: '',
              data: parsed.layout
            }];
          }
        }else{
          rawTemplates = Array.isArray(parsed.templates) ? parsed.templates : [parsed];
        }

        for(const rt of rawTemplates){
          const norm = normalizeImportedTemplate(rt, '', '');
          if(!norm){
            alert(`Falta categoría o nombre de formulario en: ${file.name}\n\nSe omite esta plantilla.`);
            continue;
          }

          const { category, form, tags, data } = norm;

          const existing = db.find(x => normalize(x.category).toLowerCase()===normalize(category).toLowerCase()
                                     && normalize(x.form).toLowerCase()===normalize(form).toLowerCase());
          if(existing){
            const ok = confirm(`Ya existe en memoria:\n${category} / ${form}\n\n¿Sobrescribir con ${file.name}?`);
            if(!ok) continue;
            existing.baseData = deepClone(data);
            existing.data = deepClone(data);
            existing.tags = tags;
            existing.sourceFileName = file.name;
          }else{
            db.push({
              id: makeId(),
              category,
              form,
              tags,
              sourceFileName: file.name,
              baseData: deepClone(data),
              data: deepClone(data)
            });
          }
        }
      }

      saveState();
      updateStatus();

      if(db.length === 1){
        openTemplate(db[0]);
      }else{
        const item = getCurrentItem();
        if(item && item.data) loadLayoutFromData(item.data);
      }
    };

    inp.click();
  }

  function clearLoaded(){
    const ok = confirm('Esto vacía la lista de plantillas importadas (no borra archivos del disco). ¿Continuar?');
    if(!ok) return;
    db.length = 0;
    currentId = null;
    lastOpenedTag = '';
    lastNFCTag = '';
    lastNFCTimeISO = null;
    safeLSRemove(STORAGE_KEY);
    safeLSRemove(INSPECTIONS_KEY);
    inspections.length = 0;
    renderEmptyDocument();
    saveState();
  }

  (function init(){
    initFirebase();
    const restored = loadState();
    // cargar inspecciones desde la nube (no bloquea la UI)
    loadInspections();

    lastEditedISO = lastEditedISO || nowISO();
    updateLastEditedUI();
    applyFixedLogo();

    // Cargar plantillas desde Firestore (fuente de verdad)
    loadTemplatesFromCloud().then(()=>{
      if(!currentId && db.length){
        // no abre automáticamente; solo habilita acciones
        updateStatus();
        updateButtons();
      }
    });

    if(restored && db.length > 0){
      const item = getCurrentItem();
      if(item && item.data){
        loadLayoutFromData(item.data);
      }else{
        currentId = null;
        renderEmptyDocument();
      }
    }else{
      renderEmptyDocument();
    }

    startNFC(true);

    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState === 'visible') startNFC(true);
    });
    window.addEventListener('focus', ()=> startNFC(true));

    const oneTap = ()=>{
      document.removeEventListener('pointerdown', oneTap, true);
      if(!nfcActive) startNFC(false);
    };
    document.addEventListener('pointerdown', oneTap, true);

    saveState();
  })();

// --- Bindings explícitos para botones inline (robustez) ---
try{
  window.importJsonFiles = importJsonFiles;
  window.exportPDF = exportPDF;
  window.exportAllInspectionsForDB = exportAllInspectionsForDB;
  
  // Override: en modo nube, no se importan plantillas por JSON local desde Inspector
  window.importJsonFiles = function(){
    alert('Modo nube: las plantillas se cargan automáticamente desde Firestore.\n\nUsa "Administrador" para crear/guardar plantillas.');
  };

  window.exportCloudInfoBBDD = exportCloudInfoBBDD;
  window.saveCurrentInspection = saveCurrentInspection;
  window.resetCurrentForm = resetCurrentForm;
  window.clearLoaded = clearLoaded;
  window.readTagAndOpen = readTagAndOpen;
  window.addPhotosToField = addPhotosToField;
  window.removePhotoFromField = removePhotoFromField;
}catch(e){ console.error(e); }

</script>

</body>
</html>
